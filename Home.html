<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home - Budget Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background: #f2faf3; margin: 0; padding: 20px; }
  .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
  h2 { text-align: center; color: #2c7a3f; margin-bottom: 20px; font-size: 26px; }
  .top-buttons { display:flex; gap:10px; justify-content:flex-end; margin-bottom: 20px; flex-wrap:wrap; }
  button { padding: 10px 14px; border: none; border-radius: 8px; cursor:pointer; font-weight:bold; color:white; transition:0.12s; }
  button:hover { transform: scale(0.98); opacity:0.95; }
  .resetHome { background:#f6a03f } .resetAll { background:#e44545 } .inputData { background:#2e8d47 } .logoutBtn { background:#444 }
  label { font-weight:bold; display:inline-block; margin-top:10px; color:#2b7a38; }
  input[type="date"], input[type="number"] { padding:9px; margin-top:5px; margin-bottom:15px; border-radius:8px; border:1px solid #8dcc90; font-size:15px; }
  .summary { background:#dff4e3; padding:16px; border-radius:12px; margin-bottom:20px; font-size:15px; }
  .summary p span { font-weight:bold; color:#146b2a; }
  .healthBarContainer { width:100%; height:22px; background:#d9e9dc; border-radius:12px; overflow:hidden; margin-top:8px; }
  .healthBarFill { height:100%; width:0%; background:#2ecc71; transition: width 0.35s ease; }
  table { width:100%; border-collapse:collapse; margin-top:20px; font-size:15px; }
  th, td { border:1px solid #b5dfbb; padding:10px; text-align:center; }
  th { background:#bfe6c7; }
  .usedBudgetInput { width:90px; padding:6px; border-radius:6px; border:1px solid #8dcc90; }
  #quickInputContainer { margin-bottom:20px; background:#e2f5e4; padding:12px; border-radius:10px; display:flex; gap:10px; align-items:center; justify-content:flex-start; }
  #welcomeWrap { text-align:right; margin-bottom:6px; color:#2c7a3f; font-weight:bold; }
  @media (max-width:720px){ .top-buttons{justify-content:center} }
</style>
</head>
<body>

<!-- welcome display -->
<div id="welcomeWrap">Logged in as: <span id="welcomeUser"></span></div>

<div class="container">
  <h2>Budget Dashboard</h2>

  <div class="top-buttons">
    <button id="btnInputData" class="inputData">Input Data</button>
    <button id="btnResetHome" class="resetHome">Reset</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnLogout" class="logoutBtn">Logout</button>
  </div>

  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
    <div>
      <label>From:</label><br>
      <input type="date" id="dateFrom" onchange="saveDates(); updateDashboard()">
    </div>
    <div>
      <label>To:</label><br>
      <input type="date" id="dateTo" onchange="saveDates(); updateDashboard()">
    </div>
  </div>

  <div id="quickInputContainer">
    <label style="margin:0;">Today's Spending:</label>
    <input type="number" id="quickInput" placeholder="Enter amount & press Enter">
    <small style="color:#597b60">(press Enter to save today quickly)</small>
  </div>

  <div class="summary">
    <p>Total Income: RM <span id="totalIncome">0</span></p>
    <p>Total Commitments: RM <span id="totalCommit">0</span></p>
    <p>Net Income: RM <span id="netIncome">0</span></p>
    <p>Days Left: <span id="daysLeft">0</span></p>
    <p>Daily Budget (varies): RM <span id="dailyBudget">0</span></p>
    <p>Remaining Net: RM <span id="remainingNet">0</span></p>

    <div class="healthBarContainer"><div id="healthBarFill" class="healthBarFill"></div></div>
    <div id="healthPercent" style="text-align:right;font-weight:bold;color:#146b2a;">0%</div>
  </div>

  <table id="budgetTable">
    <thead>
      <tr><th>Date</th><th>Daily Budget</th><th>Budget Used</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- EARLY login check (non-module) — must use same key that login/signup set: "loggedInUser" -->
<script>
(function() {
  // The login/signup you provided set localStorage with key "loggedInUser".
  // If your login page uses a different key, change this to match it.
  const KEY = "loggedInUser";
  const user = localStorage.getItem(KEY);

  // defensive checks
  if (!user || typeof user !== "string" || user.trim() === "" || user === "null" || user === "undefined") {
    localStorage.removeItem(KEY);
    alert("You must login first!");
    // redirect to login page
    window.location.href = "login.html";
    // stop further execution — module import will still be attempted by browser but we redirected.
    return;
  }

  // set a well-known global for module code to use
  window.CURRENT_USER = user;
  document.getElementById("welcomeUser").textContent = user;
})();
</script>

<!-- MAIN module script (imports firebase) -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* Firebase config (your RTDB url) */
const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Ensure CURRENT_USER was set by early script
const CURRENT = window.CURRENT_USER;
if (!CURRENT) {
  // safety: if not set, redirect to login
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
  throw new Error("Missing CURRENT user — redirected to login.");
}
const userBase = () => `users/${CURRENT}`;

/* Helper: format date in local timezone */
function formatLocalDate(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const d = String(date.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}
function parseInputDate(id) {
  const v = document.getElementById(id).value;
  if (!v) return null;
  const [y,m,d] = v.split("-");
  return new Date(Number(y), Number(m)-1, Number(d));
}

/* Load salary/partTime + commitments (user-specific) */
async function loadIncomeCommitments() {
  try {
    const salarySnap = await get(ref(db, `${userBase()}/salary`));
    const partSnap   = await get(ref(db, `${userBase()}/partTime`));
    const commitSnap = await get(ref(db, `${userBase()}/commitments`));

    const salary = Number(salarySnap.exists() ? salarySnap.val() : 0);
    const partTime = Number(partSnap.exists() ? partSnap.val() : 0);
    const commitments = commitSnap.exists() ? commitSnap.val() : {};

    let totalCommit = 0;
    const keys = ["rent","motorcycle","telco","electric","water","shopee"];
    keys.forEach(k => {
      const v = commitments[k];
      const n = Number(v || 0);
      if (!Number.isNaN(n)) totalCommit += n;
    });

    if (commitments.other) {
      const list = Array.isArray(commitments.other) ? commitments.other : Object.values(commitments.other);
      list.forEach(o => {
        const n = Number(o && o.amount ? o.amount : 0);
        if (!Number.isNaN(n)) totalCommit += n;
      });
    }

    return { totalIncome: salary + partTime, totalCommit };
  } catch (err) {
    console.error("loadIncomeCommitments error:", err);
    return { totalIncome: 0, totalCommit: 0 };
  }
}

/* Save manual edit of used budget */
window.saveUsedBudget = async function(dateStr, val) {
  try {
    const node = ref(db, `${userBase()}/homeBudget/${dateStr}`);
    if (val === "" || val === null) {
      await remove(node);
    } else {
      const n = Number(val);
      if (Number.isNaN(n)) return;
      await set(node, n);
    }
    await updateDashboard();
  } catch (err) { console.error("saveUsedBudget:", err); }
};

/* Quick input: press Enter to save today's spending */
document.getElementById("quickInput").addEventListener("keydown", async e => {
  if (e.key === "Enter") {
    const v = Number(e.target.value);
    if (isNaN(v) || v < 0) return;
    const today = formatLocalDate(new Date());
    await set(ref(db, `${userBase()}/homeBudget/${today}`), v);
    e.target.value = "";
    await updateDashboard();
  }
});

/* Update summary and health bar */
async function updateSummary(baseDaily, from, to) {
  const { totalIncome, totalCommit } = await loadIncomeCommitments();
  const net = totalIncome - totalCommit;

  const usedSnap = await get(ref(db, `${userBase()}/homeBudget`));
  let usedTotal = 0;
  if (usedSnap.exists()) {
    Object.values(usedSnap.val()).forEach(v => usedTotal += Number(v || 0));
  }

  const remaining = net - usedTotal;

  document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
  document.getElementById("totalCommit").textContent = totalCommit.toFixed(2);
  document.getElementById("netIncome").textContent = net.toFixed(2);
  document.getElementById("remainingNet").textContent = remaining.toFixed(2);
  document.getElementById("dailyBudget").textContent = baseDaily.toFixed(2);

  const today = new Date(); today.setHours(0,0,0,0);
  const daysLeft = to && to > today ? Math.max(0, Math.ceil((to - today)/86400000)) : 0;
  document.getElementById("daysLeft").textContent = daysLeft;

  let pct = totalIncome > 0 ? (remaining / totalIncome) * 100 : 0;
  pct = Math.max(0, Math.min(100, pct));
  const bar = document.getElementById("healthBarFill");
  bar.style.width = pct + "%";
  if (pct <= 20) bar.style.background = "red";
  else if (pct <= 40) bar.style.background = "orange";
  else if (pct <= 60) bar.style.background = "gold";
  else if (pct <= 80) bar.style.background = "#a2e05e";
  else bar.style.background = "#2ecc71";
  document.getElementById("healthPercent").textContent = pct.toFixed(1) + "%";
}

/* Generate table with carry-forward (previous days=0, carry to today) */
async function generateTable(from, to, baseDaily) {
  const tbody = document.querySelector("#budgetTable tbody");
  tbody.innerHTML = "";
  const snap = await get(ref(db, `${userBase()}/homeBudget`));
  const used = snap.exists() ? snap.val() : {};

  let current = new Date(from); current.setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  const todayStr = formatLocalDate(today);
  let leftover = 0;

  while (current <= to) {
    const ds = formatLocalDate(current);
    let dailyShow = baseDaily;
    if (ds < todayStr) dailyShow = 0;
    else if (ds === todayStr) dailyShow = baseDaily + leftover;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ds}</td>
      <td>${dailyShow.toFixed(2)}</td>
      <td>
        <input class="usedBudgetInput" type="number"
          value="${used[ds] ?? ""}"
          oninput="saveUsedBudget('${ds}', this.value)">
      </td>
    `;
    tbody.appendChild(tr);

    if (ds < todayStr) leftover += baseDaily - Number(used[ds] || 0);

    current.setDate(current.getDate() + 1);
  }
}

/* Main update */
window.updateDashboard = async function() {
  const fromDate = parseInputDate("dateFrom");
  const toDate = parseInputDate("dateTo");
  if (!fromDate || !toDate) return;

  const { totalIncome, totalCommit } = await loadIncomeCommitments();
  const net = totalIncome - totalCommit;
  const totalDays = Math.max(1, Math.ceil((toDate - fromDate)/86400000) + 1);
  const baseDaily = net / totalDays;

  await updateSummary(baseDaily, fromDate, toDate);
  await generateTable(fromDate, toDate, baseDaily);
};

/* load saved dates */
async function loadSavedDates() {
  try {
    const snap = await get(ref(db, `${userBase()}/homeDates`));
    if (snap.exists()) {
      const d = snap.val();
      if (d.from) document.getElementById("dateFrom").value = d.from;
      if (d.to) document.getElementById("dateTo").value = d.to;
    }
  } catch (err) {
    console.error("loadSavedDates:", err);
  }
}

/* Save date range */
window.saveDates = async function() {
  const from = document.getElementById("dateFrom").value || "";
  const to = document.getElementById("dateTo").value || "";
  await update(ref(db, `${userBase()}/homeDates`), { from, to });
};

/* Reset home (homeBudget + homeDates) */
document.getElementById("btnResetHome").onclick = async () => {
  if (!confirm("Reset only Home data? This will clear recorded daily spending and saved dates.")) return;
  await remove(ref(db, `${userBase()}/homeBudget`));
  await remove(ref(db, `${userBase()}/homeDates`));
  document.getElementById("dateFrom").value = "";
  document.getElementById("dateTo").value = "";
  await updateDashboard();
};

/* Reset all (user node only) */
document.getElementById("btnResetAll").onclick = async () => {
  if (!confirm("RESET ALL USER DATA? This removes all data under your user node.")) return;
  await remove(ref(db, `${userBase()}`));
  alert("All user data cleared.");
  location.reload();
};

/* Navigation & logout */
document.getElementById("btnInputData").onclick = () => window.location.href = "SalaryInput.html";
document.getElementById("btnLogout").onclick = () => {
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
};

/* On page load: populate dates and update dashboard */
(async function init() {
  await loadSavedDates();
  await updateDashboard();
})();
</script>

</body>
</html>

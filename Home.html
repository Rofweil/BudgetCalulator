<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Home - Budget Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2faf3;
        margin: 0;
        padding: 20px;
    }

    .container {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 14px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }

    h2 {
        text-align: center;
        color: #2c7a3f;
        margin-bottom: 20px;
        font-size: 26px;
    }

    .top-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    button {
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        transition: 0.2s;
    }

    button:hover {
        opacity: 0.85;
        transform: scale(0.98);
    }

    .resetHome { background: #f6a03f; }
    .resetAll { background: #e44545; }
    .inputData { background: #2e8d47; }

    label {
        font-weight: bold;
        margin-top: 10px;
        display: inline-block;
        color: #2b7a38;
    }

    input[type="date"], input[type="number"] {
        padding: 9px;
        margin-top: 5px;
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid #8dcc90;
        font-size: 15px;
        width: 220px;
    }

    .summary {
        background: #dff4e3;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 16px;
    }

    .summary p span {
        font-weight: bold;
        color: #146b2a;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 15px;
    }

    th, td {
        border: 1px solid #b5dfbb;
        padding: 10px;
        text-align: center;
    }

    th {
        background: #bfe6c7;
        font-weight: bold;
    }

    .usedBudget {
        width: 80px;
        padding: 6px;
        border: 1px solid #8dcc90;
        border-radius: 6px;
    }
    
    .healthBarContainer {
    width: 100%;
    height: 22px;
    background: #d9e9dc;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 6px;
}

.healthBarFill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, red, orange, yellow, #2ecc71);
    transition: width 0.4s ease;
    border-radius: 12px;
}


</style>
</head>
<body>

<div class="container">
    <h2>Budget Dashboard</h2>

    <div class="top-buttons">
    <button id="btnResetHome" class="resetHome">Reset</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnInputData" class="inputData">Input Data</button>
</div>


    <label>From:</label>
    <input type="date" id="dateFrom" onchange="saveDates(); updateDashboard()">
    <label>To:</label>
    <input type="date" id="dateTo" onchange="saveDates(); updateDashboard()">

    <div class="summary">
        <p>Total Income: RM <span id="totalIncome">0</span></p>
        <p>Total Commitments: RM <span id="totalCommit">0</span></p>
        <p>Net Income: RM <span id="netIncome">0</span></p>
        <p>Days Left Until Salary: <span id="daysLeft">0</span></p>
        <p>Daily Budget (Base): RM <span id="dailyBudget">0</span></p>
        <p>Remaining Net Income: RM <span id="remainingNet">0</span></p>
        <div style="margin-top: 15px;">
    <label style="font-weight:bold;color:#2b7a38;">Budget Health:</label>
    <div class="healthBarContainer">
        <div class="healthBarFill" id="healthBarFill"></div>
    </div>
    <div id="healthPercent" style="margin-top:5px;font-weight:bold;color:#146b2a;">0%</div>
</div>

    </div>

    <table id="budgetTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Daily Budget</th>
                <th>Budget Used</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
/* Firebase imports (match style used in your other pages) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* Firebase config - keep your project's config (unchanged) */
const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  measurementId: "G-2LL0GD2K30",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* USER PATH */
const USER = "guest_user_1";
const userBase = `users/${USER}`;

/* ----------------------------
   Helper date & DOM functions
   ---------------------------- */
function getLocalISOString(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function getLocalDate(id){
    const v = document.getElementById(id).value;
    if (!v) return null;
    const p = v.split("-");
    if (p.length !== 3) return null;
    return new Date(p[0], p[1]-1, p[2]);
}

/* ----------------------------
   Load income and commitments
   (reads root /salary & /partTime and user commitments)
   ---------------------------- */
async function loadIncomeCommitments() {
    try {
        const salarySnap = await get(ref(db, "salary"));
        const partSnap = await get(ref(db, "partTime"));

        // FIXED: commitments are stored at root level
        const commitSnap = await get(ref(db, "commitments"));

        const salary = Number(salarySnap.exists() ? salarySnap.val() : 0);
        const partTime = Number(partSnap.exists() ? partSnap.val() : 0);

        let commitments = commitSnap.exists() ? commitSnap.val() : {};
        let totalCommit = 0;

        const mainKeys = ["rent", "motorcycle", "telco", "electric", "water", "shopee"];

        mainKeys.forEach(key => {
            const val = commitments[key];
            const num = Number(val);
            if (!Number.isNaN(num) && num > 0) {
                totalCommit += num;
            }
        });

        // Future-proof: support any "other" commitments
        if (commitments.other) {
            if (Array.isArray(commitments.other)) {
                commitments.other.forEach(item => {
                    const num = Number(item.amount || 0);
                    if (!Number.isNaN(num) && num > 0) {
                        totalCommit += num;
                    }
                });
            } else if (typeof commitments.other === "object") {
                Object.values(commitments.other).forEach(item => {
                    const num = Number(item.amount || item || 0);
                    if (!Number.isNaN(num) && num > 0) {
                        totalCommit += num;
                    }
                });
            }
        }

        return {
            totalIncome: salary + partTime,
            totalCommit
        };

    } catch (err) {
        console.error("Error loading income/commitments:", err);
        return { totalIncome: 0, totalCommit: 0 };
    }
}

/* ----------------------------
   Save a single used budget entry
   Stored at /users/guest_user_1/homeBudget/{date}
   ---------------------------- */
window.saveUsedBudget = async function(dateStr, value) {
    try {
        // If empty -> remove node, else set number
        const nodeRef = ref(db, `${userBase}/homeBudget/${dateStr}`);
        if (value === "" || value === null || value === undefined) {
            await remove(nodeRef);
        } else {
            const num = Number(value);
            if (Number.isNaN(num)) return;
            await set(nodeRef, num);
        }

        // Recompute summary & optionally refresh table
        const from = getLocalDate("dateFrom");
        const to = getLocalDate("dateTo");
        if (!from || !to || from > to) return;

        const { totalIncome, totalCommit } = await loadIncomeCommitments();
        const net = totalIncome - totalCommit;
        const totalDays = Math.ceil((to - from) / 86400000) + 1;
        const base = net / totalDays;

        await updateSummaryOnly(base, from, to);
        // regenerate table to reflect any change (keeps UI consistent)
        await generateTable(from, to, base);
    } catch (err) {
        console.error("Error saving used budget:", err);
    }
};

/* ----------------------------
   Update summary fields only
   ---------------------------- */
async function updateSummaryOnly(base, from, to) {
    try {
        const { totalIncome, totalCommit } = await loadIncomeCommitments();
        const netIncome = totalIncome - totalCommit;

        const today = new Date();
        today.setHours(0,0,0,0);

        const daysLeft = Math.max(0, Math.ceil((to - today) / 86400000));

        // sum used amounts
        const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
        let totalUsed = 0;
        if (usedSnap.exists()) {
            const usedData = usedSnap.val();
            Object.values(usedData).forEach(v => totalUsed += Number(v || 0));
        }

        const remainingNet = netIncome - totalUsed;

        document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
        document.getElementById("totalCommit").textContent = totalCommit.toFixed(2);
        document.getElementById("netIncome").textContent = netIncome.toFixed(2);
        document.getElementById("daysLeft").textContent = daysLeft;
        document.getElementById("dailyBudget").textContent = base.toFixed(2);
        document.getElementById("remainingNet").textContent = remainingNet.toFixed(2);
        // -------- HEALTH BAR --------
let percent = 0;
if (totalIncome > 0) {
    percent = (remainingNet / totalIncome) * 100;
    if (percent < 0) percent = 0;
    if (percent > 100) percent = 100;
}

let bar = document.getElementById("healthBarFill");
let txt = document.getElementById("healthPercent");

// Smooth width fill
bar.style.width = percent + "%";

// Dynamic color change
if (percent <= 20) bar.style.background = "red";
else if (percent <= 40) bar.style.background = "orange";
else if (percent <= 60) bar.style.background = "gold";
else if (percent <= 80) bar.style.background = "#a2e05e";
else bar.style.background = "#2ecc71";

// Update percentage text
txt.textContent = percent.toFixed(1) + "%";

    } catch (err) {
        console.error("Error updating summary:", err);
    }
}

/* ----------------------------
   Build the per-day table
   ---------------------------- */
async function generateTable(from, to, base) {
    try {
        const tbody = document.querySelector("#budgetTable tbody");
        tbody.innerHTML = "";

        const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
        const usedData = usedSnap.exists() ? usedSnap.val() : {};

        const today = new Date();
        today.setHours(0,0,0,0);
        const oneDay = 86400000;
        const tomorrow = new Date(today.getTime() + oneDay);

        const todayStr = getLocalISOString(today);
        const tomorrowStr = getLocalISOString(tomorrow);

        function leftover(yesterdayStr) {
            if (!usedData[yesterdayStr]) return 0;
            return base - Number(usedData[yesterdayStr]);
        }

        let current = new Date(from);
        current.setHours(0,0,0,0);

        while (current <= to) {
            const dateStr = getLocalISOString(current);
            const row = document.createElement("tr");

            const dateCell = document.createElement("td");
            dateCell.textContent = dateStr;

            const budgetCell = document.createElement("td");
            let show = "-";

            if (dateStr === todayStr) {
                const y = new Date(today.getTime() - oneDay);
                show = (base + leftover(getLocalISOString(y))).toFixed(2);
            } else if (dateStr === tomorrowStr) {
                show = (base + leftover(todayStr)).toFixed(2);
            }

            budgetCell.textContent = show;

            const usedCell = document.createElement("td");
            const input = document.createElement("input");
            input.type = "number";
            input.className = "usedBudget";
            input.value = usedData[dateStr] !== undefined ? usedData[dateStr] : "";

            // Save on input (debounce not implemented - keeps behavior like before)
            input.oninput = () => window.saveUsedBudget(dateStr, input.value);

            usedCell.appendChild(input);

            row.appendChild(dateCell);
            row.appendChild(budgetCell);
            row.appendChild(usedCell);
            tbody.appendChild(row);

            current.setDate(current.getDate() + 1);
        }
    } catch (err) {
        console.error("Error generating table:", err);
    }
}

/* ----------------------------
   Main dashboard update
   ---------------------------- */
window.updateDashboard = async function() {
    const from = getLocalDate("dateFrom");
    const to = getLocalDate("dateTo");
    if (!from || !to || from > to) return;

    try {
        const { totalIncome, totalCommit } = await loadIncomeCommitments();
        const net = totalIncome - totalCommit;

        const totalDays = Math.ceil((to - from) / 86400000) + 1;
        const base = net / totalDays;

        await updateSummaryOnly(base, from, to);
        await generateTable(from, to, base);
    } catch (err) {
        console.error("Error updating dashboard:", err);
    }
};

/* ----------------------------
   Save date range under user
   ---------------------------- */
window.saveDates = async function() {
    try {
        const from = document.getElementById("dateFrom").value || "";
        const to = document.getElementById("dateTo").value || "";
        await update(ref(db, `${userBase}/homeDates`), { from, to });
    } catch (err) {
        console.error("Error saving dates:", err);
    }
};

/* ----------------------------
   Reset functions
   ---------------------------- */
window.resetHome = async function() {
    if (!confirm("Reset only Home budget data? This will clear home spending and dates.")) return;
    try {
        await remove(ref(db, `${userBase}/homeBudget`));
        await remove(ref(db, `${userBase}/homeDates`));
        // Clear UI
        document.querySelector("#budgetTable tbody").innerHTML = "";
        document.getElementById("dateFrom").value = "";
        document.getElementById("dateTo").value = "";
        // Recompute summary
        updateDashboard();
    } catch (err) {
        console.error("Error resetting home data:", err);
        alert("Reset Home failed. See console.");
    }
};

window.resetAll = async function() {
    if (!confirm("Reset ALL data? This will delete Salary, Part-Time, Commitments, and all Home data.")) return;

    try {
        // 1. Remove salary & part-time
        await remove(ref(db, "salary"));
        await remove(ref(db, "partTime"));

        // 2. Remove global commitments completely
        const commitRef = ref(db, "commitments");
        await remove(commitRef); // Removes object

        // Safety: also remove children explicitly (Firebase edge case when values are empty string)
        const commitKeys = ["electric", "motorcycle", "rent", "shopee", "telco", "water"];
        for (const key of commitKeys) {
            await remove(ref(db, `commitments/${key}`));
        }

        // 3. Remove all user-specific data
        await remove(ref(db, `${userBase}`)); // removes homeDates + homeBudget + future nodes

        alert("All data has been fully reset.");
        location.reload();

    } catch (err) {
        console.error("Error resetting all:", err);
        alert("Reset All failed. Check console.");
    }
};



/* ----------------------------
   Navigation
   ---------------------------- */
window.goInput = function() {
    window.location.href = "SalaryInput.html";
};

/* ----------------------------
   Page load: fill dates then update dashboard
   ---------------------------- */
window.onload = async function() {
    try {
        const dSnap = await get(ref(db, `${userBase}/homeDates`));
        if (dSnap.exists()) {
            const d = dSnap.val();
            if (d.from) document.getElementById("dateFrom").value = d.from;
            if (d.to) document.getElementById("dateTo").value = d.to;
        }
    } catch (err) {
        console.error("Error loading saved dates:", err);
    }
    // call updateDashboard (safe even if dates not set)
    window.updateDashboard();
};
    //------------------------------------------------------------
// Attach button event listeners (Fix for module-scoped functions)
//------------------------------------------------------------
document.getElementById("btnResetHome").addEventListener("click", () => {
    if (window.resetHome) window.resetHome();
});

document.getElementById("btnResetAll").addEventListener("click", () => {
    if (window.resetAll) window.resetAll();
});

document.getElementById("btnInputData").addEventListener("click", () => {
    if (window.goInput) window.goInput();
    else window.location.href = "SalaryInput.html";
});

</script>

</body>
</html>






<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Home - Budget Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f2faf3;margin:0;padding:18px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .userRow{display:flex;gap:10px;align-items:center;color:#2c7a3f;font-weight:700}
  #btnLogout{background:#444;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .container{max-width:960px;margin:10px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  h2{text-align:center;color:#2c7a3f;margin:0 0 16px}
  .top-buttons{display:flex;gap:10px;justify-content:flex-start;margin-bottom:14px}
  .top-buttons button{padding:10px 14px;border-radius:8px;border:none;color:#fff;font-weight:700;cursor:pointer}
  .resetHome{background:#f6a03f}.resetAll{background:#e44545}.inputData{background:#2e8d47}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  label{font-weight:700;color:#2b7a38}
  input[type="date"],input[type="number"],#spendInput{padding:9px;border-radius:8px;border:1px solid #8dcc90;font-size:15px}
  #spendInput{width:240px}
  .summary{background:#dff4e3;padding:12px;border-radius:10px;margin-bottom:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:center}
  .summary .item{font-size:15px}
  .summary .item strong{color:#146b2a;margin-left:6px}
  .healthBarContainer{grid-column:1/-1;height:20px;background:#e6f2e9;border-radius:10px;overflow:hidden;margin-top:6px}
  .healthBarFill{height:100%;width:0%;background:linear-gradient(90deg,#f44336,#ff9800,#ffeb3b,#4caf50);transition:width .35s ease;border-radius:10px}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border:1px solid #d7efd7;padding:10px;text-align:center}
  th{background:#cfead0}
  .usedBudget{width:110px;padding:6px;border-radius:6px;border:1px solid #8dcc90}
  .smallNote{font-size:12px;color:#666}
  @media(max-width:700px){ .summary{grid-template-columns:1fr} #spendInput{width:160px} }
</style>
</head>
<body>

<!-- QUICK LOGIN BLOCKER (runs immediately before modules load) -->
<script>
  // immediate check so page can't be accessed before module loads
  const _user = localStorage.getItem("loggedInUser");
  if (!_user) {
    alert("You must login first.");
    window.location.href = "login.html";
  }
</script>

<div class="topbar">
  <div class="userRow">
    Logged in as: <span id="welcomeUser" style="margin-left:8px;"></span>
  </div>
  <div>
    <button id="btnLogout">Logout</button>
  </div>
</div>

<div class="container">
  <h2>Budget Dashboard</h2>

  <div class="top-buttons" style="margin-bottom:8px;">
    <button id="btnResetHome" class="resetHome">Reset</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnInputData" class="inputData">Input Data</button>
  </div>

  <div class="controls">
    <div>
      <label>From:</label>
      <input type="date" id="dateFrom">
    </div>

    <div>
      <label>To:</label>
      <input type="date" id="dateTo">
    </div>

    <div>
      <label for="spendInput">Enter Spending Amount</label><br>
      <input id="spendInput" type="number" placeholder="e.g. 10.50" step="0.01" />
      <div class="smallNote">Type an amount and press Enter to add to today's spending</div>
    </div>
  </div>

  <div class="summary" id="summaryBlock">
    <div class="item">Total Income: RM <strong id="totalIncome">0.00</strong></div>
    <div class="item">Total Commitments: RM <strong id="totalCommit">0.00</strong></div>
    <div class="item">Net Income: RM <strong id="netIncome">0.00</strong></div>

    <div class="item">Days Left: <strong id="daysLeft">0</strong></div>
    <div class="item">Daily Budget: RM <strong id="dailyBudget">0.00</strong></div>
    <div class="item">Remaining Net: RM <strong id="remainingNet">0.00</strong></div>

    <div style="grid-column:1/-1">
      <div class="healthBarContainer"><div id="healthBarFill" class="healthBarFill"></div></div>
      <div style="text-align:right;margin-top:6px;"><span id="healthPercent" style="font-weight:700;color:#146b2a">0%</span></div>
    </div>
  </div>

  <table id="budgetTable">
    <thead>
      <tr><th>Date</th><th>Daily Budget</th><th>Budget Used (editable)</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase module + logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  measurementId: "G-2LL0GD2K30",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- USER & DOM ---------- */
const USER = localStorage.getItem("loggedInUser"); // must match login
if (!USER) {
  // safety (should've been blocked by top script)
  alert("You must login first.");
  window.location.href = "login.html";
  throw new Error("Not logged in");
}
document.getElementById("welcomeUser").textContent = USER;
const userBase = `users/${USER}`;

const dateFromEl = document.getElementById("dateFrom");
const dateToEl = document.getElementById("dateTo");
const spendInput = document.getElementById("spendInput");
const tbody = document.querySelector("#budgetTable tbody");

/* ---------- util ---------- */
function isoDate(d) {
  const dt = new Date(d);
  dt.setHours(0,0,0,0);
  return dt.toISOString().split("T")[0];
}
function todayISO() { return isoDate(new Date()); }
function toNumber(v){ const n = parseFloat(v); return isNaN(n)?0:n; }

/* ---------- Load income & commitments (per-user) ---------- */
async function loadIncomeCommitments() {
  try {
    const salarySnap = await get(ref(db, `${userBase}/salary`));
    const partSnap = await get(ref(db, `${userBase}/partTime`));
    const commitSnap = await get(ref(db, `${userBase}/commitments`));

    const salary = salarySnap.exists()? Number(salarySnap.val()):0;
    const partTime = partSnap.exists()? Number(partSnap.val()):0;
    const commits = commitSnap.exists()? commitSnap.val(): {};

    let totalCommit = 0;
    const keys = ["rent","motorcycle","telco","electric","water","shopee"];
    keys.forEach(k => {
      const n = Number(commits[k]||0);
      if (!isNaN(n)) totalCommit += n;
    });

    // accept other format
    if (commits.other) {
      if (Array.isArray(commits.other)) commits.other.forEach(o => totalCommit += Number(o.amount||0));
      else Object.values(commits.other).forEach(o => totalCommit += Number((o && (o.amount||o))||0));
    }

    return { totalIncome: salary + partTime, totalCommit };
  } catch(e) {
    console.error("loadIncomeCommitments", e);
    return { totalIncome: 0, totalCommit: 0 };
  }
}

/* ---------- Save single date value (overwrite) ---------- */
async function saveUsedBudgetForDate(dateStr, value) {
  try {
    const node = ref(db, `${userBase}/homeBudget/${dateStr}`);
    if (value === "" || value === null || value === undefined) {
      await remove(node);
    } else {
      await set(node, Number(value));
    }
  } catch(e) {
    console.error("saveUsedBudgetForDate", e);
  }
}

/* ---------- Add-to-today logic (spend input) ---------- */
async function addSpendToToday(amount) {
  try {
    const dateStr = todayISO();
    const nodeRef = ref(db, `${userBase}/homeBudget/${dateStr}`);
    const snap = await get(nodeRef);
    const existing = snap.exists()? Number(snap.val()):0;
    const toSave = existing + Number(amount);
    await set(nodeRef, toSave);
    // clear input
    spendInput.value = "";
    // update UI
    await updateDashboard(); // regenerates table + summary
    // focus back
    spendInput.focus();
  } catch(e) {
    console.error("addSpendToToday", e);
    alert("Failed to add spending. See console.");
  }
}

/* ---------- Generate table ---------- */
async function generateTable(fromDate, toDate, base) {
  try {
    tbody.innerHTML = "";
    const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
    const used = usedSnap.exists()? usedSnap.val(): {};

    const from = new Date(fromDate); from.setHours(0,0,0,0);
    const to = new Date(toDate); to.setHours(0,0,0,0);
    const oneDay = 86400000;
    let cur = new Date(from);

    while (cur <= to) {
      const ds = isoDate(cur);
      const tr = document.createElement("tr");

      // compute daily budget display (only special for today/tomorrow can be improved later)
      const budgetCell = base!==null ? base.toFixed(2) : "-";

      const usedVal = used[ds] !== undefined ? used[ds] : "";

      tr.innerHTML = `
        <td>${ds}</td>
        <td>${budgetCell}</td>
        <td>
          <input class="usedBudget" type="number" step="0.01" value="${usedVal}" data-date="${ds}" />
        </td>
      `;

      tbody.appendChild(tr);

      // attach listener for manual edits (overwrite)
      const input = tr.querySelector(".usedBudget");
      input.addEventListener("change", async (ev) => {
        const v = ev.target.value;
        if (v === "") {
          await saveUsedBudgetForDate(ds, "");
        } else {
          await saveUsedBudgetForDate(ds, Number(v));
        }
        // refresh summary
        await updateSummaryOnly(base, from, to);
      });

      cur = new Date(cur.getTime() + oneDay);
    }
  } catch(e) {
    console.error("generateTable", e);
  }
}

/* ---------- Update summary (and health bar) ---------- */
async function updateSummaryOnly(base, from, to) {
  try {
    const { totalIncome, totalCommit } = await loadIncomeCommitments();
    const net = totalIncome - totalCommit;

    // sum used
    const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
    let usedTotal = 0;
    if (usedSnap.exists()) {
      Object.values(usedSnap.val()).forEach(v => usedTotal += Number(v||0));
    }

    const remainingNet = net - usedTotal;

    // days left: use 'to' as salary day context
    const today = new Date(); today.setHours(0,0,0,0);
    const daysLeft = Math.max(0, Math.ceil((to - today)/86400000));

    document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
    document.getElementById("totalCommit").textContent = totalCommit.toFixed(2);
    document.getElementById("netIncome").textContent = net.toFixed(2);
    document.getElementById("daysLeft").textContent = daysLeft;
    document.getElementById("dailyBudget").textContent = (base !== null ? base.toFixed(2) : "0.00");
    document.getElementById("remainingNet").textContent = remainingNet.toFixed(2);

    // health percent = remainingNet / totalIncome
    let percent = totalIncome > 0 ? (remainingNet / totalIncome) * 100 : 0;
    percent = Math.max(0, Math.min(100, percent));
    const bar = document.getElementById("healthBarFill");
    const txt = document.getElementById("healthPercent");
    bar.style.width = percent + "%";
    if (percent <= 20) bar.style.background = "red";
    else if (percent <= 40) bar.style.background = "orange";
    else if (percent <= 60) bar.style.background = "gold";
    else if (percent <= 80) bar.style.background = "#a2e05e";
    else bar.style.background = "#2ecc71";
    txt.textContent = percent.toFixed(1) + "%";
  } catch(e) {
    console.error("updateSummaryOnly", e);
  }
}

/* ---------- Main update function ---------- */
async function updateDashboard() {
  try {
    // if not set, default to today (so table shows something)
    const df = dateFromEl.value;
    const dt = dateToEl.value;
    let fromDate = df ? new Date(df) : new Date();
    let toDate   = dt ? new Date(dt) : new Date();
    fromDate.setHours(0,0,0,0);
    toDate.setHours(0,0,0,0);

    // compute base daily budget
    const { totalIncome, totalCommit } = await loadIncomeCommitments();
    const net = totalIncome - totalCommit;
    const days = Math.ceil((toDate - fromDate)/86400000) + 1;
    const base = days > 0 ? net / days : null;

    await updateSummaryOnly(base, fromDate, toDate);
    await generateTable(fromDate, toDate, base);
  } catch(e) {
    console.error("updateDashboard", e);
  }
}

/* ---------- Save date range to DB (user-specific) ---------- */
async function saveDates() {
  try {
    const from = dateFromEl.value || "";
    const to = dateToEl.value || "";
    await update(ref(db, `${userBase}/homeDates`), { from, to });
    // refresh dashboard
    await updateDashboard();
  } catch(e) {
    console.error("saveDates", e);
  }
}

/* ---------- Reset actions ---------- */
async function resetHome() {
  if (!confirm("Reset only Home budget data? This will clear today's and historical home spending and dates.")) return;
  try {
    await remove(ref(db, `${userBase}/homeBudget`));
    await remove(ref(db, `${userBase}/homeDates`));
    dateFromEl.value = "";
    dateToEl.value = "";
    await updateDashboard();
  } catch(e) { console.error("resetHome", e); alert("Reset home failed"); }
}

async function resetAll() {
  if (!confirm("Reset ALL data for this user? This deletes salary, commitments, home data.")) return;
  try {
    await remove(ref(db, `${userBase}`));
    localStorage.removeItem("loggedInUser");
    alert("All data cleared for this user.");
    window.location.href = "login.html";
  } catch(e) { console.error("resetAll", e); alert("Reset all failed"); }
}

/* ---------- Navigation ---------- */
function goInput() { window.location.href = "SalaryInput.html"; }

/* ---------- Event wiring ---------- */
document.getElementById("btnLogout").addEventListener("click", () => {
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
});

document.getElementById("btnResetHome").addEventListener("click", resetHome);
document.getElementById("btnResetAll").addEventListener("click", resetAll);
document.getElementById("btnInputData").addEventListener("click", goInput);

dateFromEl.addEventListener("change", saveDates);
dateToEl.addEventListener("change", saveDates);

// spendInput: press Enter to add-to-today
spendInput.addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") {
    const v = spendInput.value;
    if (v === "" || v === null) return;
    // allow negative to undo
    const num = Number(v);
    if (isNaN(num)) { alert("Please enter a valid number"); return; }
    addSpendToToday(num);
  }
});

// initial load: try to restore saved dates then update
(async function init() {
  try {
    const dSnap = await get(ref(db, `${userBase}/homeDates`));
    if (dSnap.exists()) {
      const d = dSnap.val();
      if (d.from) dateFromEl.value = d.from;
      if (d.to) dateToEl.value = d.to;
    } else {
      // default to today for convenience (not saved)
      const t = todayISO();
      dateFromEl.value = t;
      dateToEl.value = t;
    }
    await updateDashboard();
  } catch(e) {
    console.error("init", e);
  }
})();
</script>
</body>
</html>

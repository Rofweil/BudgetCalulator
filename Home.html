<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" sizes="64x64" type="image/png" href="favicon-64.png">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Home - Budget</title>
<style>
  body {
      background-image: url('BudgetCalculator.png'); 
      background-size: cover;
      background-position: center;
        background-repeat: no-repeat;
      background-attachment: fixed;
  }
  body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(3px);
      z-index: -1;
  }
  :root{--accent:#2c7a3f;--muted:#8dcc90;--danger:#e44545}
  /*body{font-family:Arial,Helvetica,sans-serif;background:#f2faf3;margin:0;padding:15px}*/
  .container{max-width:1000px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  .top-buttons{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;margin-bottom:12px}
  button{flex:1;padding:10px;border-radius:8px;border:none;color:#fff;font-weight:bold}
  .resetHome{background:#f6a03f}.resetAll{background:var(--danger)}.inputData{background:#2e8d47}.logoutBtn{background:#444}
  .saveTodayBtn{background:var(--accent)}
  label{font-weight:bold;display:block;margin-top:8px;color:#2b7a38}
  input[type="date"],input[type="number"],select{width:100%;padding:9px;margin-top:6px;border-radius:8px;border:1px solid var(--muted);box-sizing:border-box}
  .controls-row{display:flex;gap:8px;align-items:center}
  .controls-row > *{flex:1}
  .summary{background:#dff4e3;padding:12px;border-radius:10px;margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #b5dfbb;padding:8px;text-align:center}
  th{background:#bfe6c7}
  .usedBudgetInput{width:80px;padding:6px}
  .mobile-hide{display:inline}
  @media(max-width:640px){
    .top-buttons{flex-direction:column}
    .controls-row{flex-direction:column}
    .usedBudgetInput{width:60px}
    .mobile-hide{display:none}
  }
  .info-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .info {flex:1;background:#f7fff6;padding:10px;border-radius:8px}
  .small {font-size:13px;color:#333}
</style>
</head>
<body>

<p style="text-align:right;color:var(--accent);font-weight:bold;margin:4px 0">
  Logged in as: <span id="welcomeUser">—</span>
</p>

<!-- LOGIN CHECK (runs early) -->
<script>
(function(){
  const A = localStorage.getItem("loggedInUser");
  const B = localStorage.getItem("loggedUser");
  const U = A || B || null;
  if(!U || U.trim()==="" || U==="null" || U==="undefined"){
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedUser");
    alert("You must login first!");
    window.location.href = "login.html";
    return;
  }
  window.CURRENT_USER = U;
  document.addEventListener("DOMContentLoaded", ()=> {
    document.getElementById("welcomeUser").textContent = U;
  });
})();
</script>

<div class="container">
  <h2 style="text-align:center;color:var(--accent);margin:0 0 10px">Budget Dashboard</h2>

  <div class="top-buttons">
    <button id="btnResetHome" class="resetHome">Reset Home</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnInputData" class="inputData">Input Data</button>
    <button id="btnReport" class="resetHome" style="background:#1f8dd6">Generate Report</button>
    <button id="btnLogout" class="logoutBtn mobile-hide">Logout</button>
  </div>

  <div class="controls-row">
    <div>
      <label>From</label>
      <input id="dateFrom" type="date">
    </div>
    <div>
      <label>To</label>
      <input id="dateTo" type="date">
    </div>
    <div style="flex:0 0 150px">
      <label style="visibility:hidden">Save</label>
      <button id="btnSaveDates" style="width:100%;padding:10px;border-radius:8px;background:#3b9d58;color:#fff;font-weight:bold">Save Dates</button>
    </div>
  </div>

  <label>Today's Spending</label>
  <div class="controls-row">
    <input id="quickInput" type="number" placeholder="Enter amount (will be ADDED to today)">
    <button id="saveToday" class="saveTodayBtn" style="flex:0 0 160px">Save Today's Spending</button>
  </div>

  <div class="summary">
    <div class="info-row">
      <div class="info">
        <div class="small">Total Income (salary + part-time + additional)</div>
        <div style="font-weight:bold;font-size:18px">RM <span id="totalIncome">0.00</span></div>
      </div>
      <div class="info">
        <div class="small">Total Commitments</div>
        <div style="font-weight:bold;font-size:18px">RM <span id="totalCommit">0.00</span></div>
      </div>
      <div class="info">
        <div class="small">Remaining Net</div>
        <div style="font-weight:bold;font-size:18px">RM <span id="remainingNet">0.00</span></div>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:12px;flex-wrap:wrap">
      <div class="small">Days Left: <strong><span id="daysLeft">0</span></strong></div>
      <div class="small">Daily Budget: RM <strong><span id="dailyBudget">0.00</span></strong></div>
      <div class="small">Part-time Earned: RM <strong><span id="partTimeEarned">0.00</span></strong></div>
    </div>
  </div>

  <table id="budgetTable" aria-live="polite" role="table">
    <thead>
      <tr><th>Date</th><th>Daily Budget</th><th>Budget Used</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function userBase(){ return `users/${window.CURRENT_USER}`; }

function formatLocalDate(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseInputDate(id){
  const v=document.getElementById(id).value;
  if(!v) return null;
  const [y,m,d]=v.split("-");
  return new Date(Number(y), Number(m)-1, Number(d));
}
function two(n){ return Number(n).toFixed(2); }

/* === LOAD ALL INCOME SOURCES === */
async function loadIncomeData(){
  const [salSnap, addSnap, commitSnap, dailySnap] = await Promise.all([
    get(ref(db, userBase()+"/salary")),
    get(ref(db, userBase()+"/additionalIncome")),
    get(ref(db, userBase()+"/commitments")),
    get(ref(db, userBase()+"/partTimeDaily/records"))
  ]);

  const salary = Number(salSnap.exists()? salSnap.val() : 0);
  const additional = Number(addSnap.exists()? addSnap.val() : 0);

  let partTimeEarned = 0;
  if(dailySnap.exists()){
    Object.values(dailySnap.val()).forEach(v=>{
      const n=Number(v||0);
      if(!isNaN(n)) partTimeEarned+=n;
    });
  }

  const commits = commitSnap.exists()? commitSnap.val() : {};
  let totalCommit = 0;

  const mainKeys=["rent","vehicleLoan","telco","electric","water","shopee","motorcycle"];
  mainKeys.forEach(k=> totalCommit += Number(commits[k] || 0));

  if(commits.other){
    const list = Array.isArray(commits.other) ? commits.other : Object.values(commits.other);
    list.forEach(o => totalCommit += Number(o.amount || 0));
  }

  return {
    salary,
    additional,
    partTimeEarned,
    totalIncome: salary + additional + partTimeEarned,
    totalCommit
  };
}
async function generateReport() {
  const user = window.CURRENT_USER;
  if (!user) { alert("Not logged in"); return; }

  // Firebase paths
  const base = `users/${user}`;

  // Load all needed data
  const [salarySnap, addSnap, commitSnap, ptSnap, homeDatesSnap, homeBudgetSnap] = await Promise.all([
    get(ref(db, `${base}/salary`)),
    get(ref(db, `${base}/additionalIncome`)),
    get(ref(db, `${base}/commitments`)),
    get(ref(db, `${base}/partTimeDaily/records`)),
    get(ref(db, `${base}/homeDates`)),
    get(ref(db, `${base}/homeBudget`))
  ]);

  const salary = Number(salarySnap.exists() ? salarySnap.val() : 0);
  const additionalIncome = Number(addSnap.exists() ? addSnap.val() : 0);

  // Part-Time Earnings
  let ptData = [];
  let ptTotal = 0;
  if (ptSnap.exists()) {
    const obj = ptSnap.val();
    Object.entries(obj).forEach(([date, amount]) => {
      const n = Number(amount || 0);
      if (!isNaN(n)) {
        ptData.push({ Date: date, Earned: n });
        ptTotal += n;
      }
    });
  }

  // Commitments
  const commitments = commitSnap.exists() ? commitSnap.val() : {};
  let commitList = [];
  let commitTotal = 0;

  const keys = ["rent","vehicleLoan","telco","electric","water","shopee","motorcycle"];
  keys.forEach(k => {
    const val = Number(commitments[k] || 0);
    if (!isNaN(val) && val !== 0) {
      commitList.push({ Type: k, Amount: val });
      commitTotal += val;
    }
  });

  if (commitments.other) {
    const others = Array.isArray(commitments.other) ? commitments.other : Object.values(commitments.other);
    others.forEach(o => {
      const n = Number(o.amount || 0);
      if (!isNaN(n)) {
        commitList.push({ Type: o.title || "Other", Amount: n });
        commitTotal += n;
      }
    });
  }

  // Date Range
  const fromDate = homeDatesSnap.exists() ? homeDatesSnap.val().from : "";
  const toDate = homeDatesSnap.exists() ? homeDatesSnap.val().to : "";

  // Home Daily Spending
  let homeDailyList = [];
  let totalUsed = 0;
  if (homeBudgetSnap.exists()) {
    const obj = homeBudgetSnap.val();
    Object.entries(obj).forEach(([date, amount]) => {
      const n = Number(amount || 0);
      if (!isNaN(n)) {
        homeDailyList.push({
          Date: date,
          "Budget Used": n
        });
        totalUsed += n;
      }
    });
  }

  const totalIncome = salary + additionalIncome + ptTotal;
  const remaining = totalIncome - commitTotal - totalUsed;

  // ======================
  // CREATE WORKBOOK
  // ======================
  const wb = XLSX.utils.book_new();

  // ----------------------
  // SHEET 1: OVERVIEW
  // ----------------------
  const overviewSheet = XLSX.utils.json_to_sheet([
    { Field: "User", Value: user },
    { Field: "Generated On", Value: new Date().toLocaleString() },
    { Field: "Period", Value: `${fromDate || "—"} to ${toDate || "—"}` },
    {},
    { Field: "Main Salary", Value: salary },
    { Field: "Additional Income", Value: additionalIncome },
    { Field: "Part-Time Earned", Value: ptTotal },
    { Field: "Total Income", Value: totalIncome },
    {},
    { Field: "Commitments Total", Value: commitTotal },
    { Field: "Total Spending", Value: totalUsed },
    { Field: "Remaining Balance", Value: remaining }
  ]);

  XLSX.utils.book_append_sheet(wb, overviewSheet, "Overview");

  // ----------------------
  // SHEET 2: Commitments
  // ----------------------
  const commitSheet = XLSX.utils.json_to_sheet(commitList);
  XLSX.utils.book_append_sheet(wb, commitSheet, "Commitments");

  // ----------------------
  // SHEET 3: Part-Time
  // ----------------------
  const ptSheet = XLSX.utils.json_to_sheet(ptData);
  XLSX.utils.book_append_sheet(wb, ptSheet, "Part-Time Earnings");

  // ----------------------
  // SHEET 4: Home Daily Spending
  // ----------------------
  const homeSheet = XLSX.utils.json_to_sheet(homeDailyList);
  XLSX.utils.book_append_sheet(wb, homeSheet, "Daily Spending");

  // ----------------------
  // DOWNLOAD
  // ----------------------
  const filename = `Spendli_Report_${fromDate || "noDate"}_to_${toDate || "noDate"}.xlsx`;
  XLSX.writeFile(wb, filename);

  alert("Report generated!");
}

document.getElementById("btnReport").addEventListener("click", generateReport);


/* === Save manual edits === */
window.saveUsedBudget = async function(dateStr,val){
  const node=ref(db, userBase()+"/homeBudget/"+dateStr);
  if(val==="" || val===null) await remove(node);
  else{
    const n=Number(val);
    if(!isNaN(n)) await set(node,n);
  }
  await updateDashboard();
};

/* === Save TODAY (ADD not overwrite) === */
document.getElementById("saveToday").addEventListener("click", async ()=>{
  const add=Number(document.getElementById("quickInput").value);
  if(isNaN(add) || add<=0) return;
  const today=formatLocalDate(new Date());
  const snap=await get(ref(db, userBase()+"/homeBudget/"+today));
  const existing=snap.exists()? Number(snap.val()) : 0;
  await set(ref(db, userBase()+"/homeBudget/"+today), existing + add);
  document.getElementById("quickInput").value="";
  await updateDashboard();
});

/* === Save Dates === */
document.getElementById("btnSaveDates").onclick = async ()=>{
  const f=document.getElementById("dateFrom").value;
  const t=document.getElementById("dateTo").value;
  await update(ref(db, userBase()+"/homeDates"), {from:f,to:t});
  alert("Dates saved.");
  await updateDashboard();
};

/* === SUMMARY AREA === */
async function updateSummary(baseDaily, fromDate, toDate){
  const {totalIncome,totalCommit,partTimeEarned,additional}= await loadIncomeData();

  const usedSnap = await get(ref(db, userBase()+"/homeBudget"));
  let usedTotal = 0;
  if(usedSnap.exists()){
    Object.values(usedSnap.val()).forEach(v=> usedTotal += Number(v||0));
  }

  const remaining = (totalIncome - totalCommit) - usedTotal;

  document.getElementById("totalIncome").textContent = two(totalIncome);
  document.getElementById("totalCommit").textContent = two(totalCommit);
  document.getElementById("remainingNet").textContent = two(remaining);
  document.getElementById("dailyBudget").textContent = two(baseDaily);
  document.getElementById("partTimeEarned").textContent = two(partTimeEarned);

  const today=new Date(); today.setHours(0,0,0,0);
  const daysLeft=Math.max(0,Math.ceil((toDate - today)/86400000));
  document.getElementById("daysLeft").textContent = daysLeft;
}

/* === Generate Table === */
async function generateTable(from,to,baseDaily){
  const tbody=document.querySelector("#budgetTable tbody");
  tbody.innerHTML="";
  const usedSnap=await get(ref(db, userBase()+"/homeBudget"));
  const used=usedSnap.exists()? usedSnap.val() : {};

  let current=new Date(from); current.setHours(0,0,0,0);
  const today=new Date(); today.setHours(0,0,0,0);
  const todayStr=formatLocalDate(today);

  let leftover=0;

  while(current<=to){
    const ds=formatLocalDate(current);
    let show=baseDaily;
    if(ds < todayStr) show=0;
    else if(ds === todayStr) show = baseDaily + leftover;

    const val = used[ds]!==undefined ? used[ds] : "";

    const row=document.createElement("tr");
    row.innerHTML = `
      <td>${ds}</td>
      <td>${two(show)}</td>
      <td><input class="usedBudgetInput" type="number" value="${val}"
          oninput="saveUsedBudget('${ds}', this.value)"></td>
    `;
    tbody.appendChild(row);

    if(ds < todayStr) leftover += baseDaily - Number(used[ds]||0);

    current.setDate(current.getDate()+1);
  }
}

/* === Main Dashboard === */
window.updateDashboard = async function(){
  const from=parseInputDate("dateFrom");
  const to=parseInputDate("dateTo");
  if(!from || !to) return;

  const {totalIncome,totalCommit} = await loadIncomeData();
  const net=totalIncome - totalCommit;
  const totalDays=Math.max(1,Math.ceil((to - from)/86400000)+1);
  const base=net/totalDays;

  await updateSummary(base, from, to);
  await generateTable(from, to, base);
};

/* === Load Saved Dates === */
async function loadSavedDates(){
  const snap=await get(ref(db, userBase()+"/homeDates"));
  if(snap.exists()){
    const d=snap.val();
    if(d.from) document.getElementById("dateFrom").value=d.from;
    if(d.to) document.getElementById("dateTo").value=d.to;
  }
}

/* === Buttons === */
document.getElementById("btnResetHome").onclick = async ()=>{
  if(!confirm("Reset Home data?")) return;
  await remove(ref(db, userBase()+"/homeBudget"));
  await remove(ref(db, userBase()+"/homeDates"));
  location.reload();
};

document.getElementById("btnResetAll").onclick = async ()=>{
  if(!confirm("RESET ALL USER DATA?")) return;
  await remove(ref(db, userBase()));
  alert("All data cleared.");
  location.reload();
};

document.getElementById("btnInputData").onclick = ()=> window.location.href="SalaryInput.html";

document.getElementById("btnLogout").onclick = ()=>{
  localStorage.removeItem("loggedInUser");
  localStorage.removeItem("loggedUser");
  window.location.href="login.html";
};

/* === On Load === */
window.addEventListener("DOMContentLoaded", async ()=>{
  if(!window.CURRENT_USER){
    window.CURRENT_USER = localStorage.getItem("loggedInUser") || localStorage.getItem("loggedUser");
    if(!window.CURRENT_USER){
      alert("You must login first!"); window.location.href="login.html"; return;
    }
  }

  await loadSavedDates();
  await updateDashboard();
});
</script>

</body>
</html>



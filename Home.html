<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Home - Budget Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f2faf3;margin:0;padding:18px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
  .userRow{display:flex;gap:10px;align-items:center;color:#2c7a3f;font-weight:700}
  #btnLogout{background:#444;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .container{max-width:960px;margin:10px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  h2{text-align:center;color:#2c7a3f;margin:0 0 16px}
  .top-buttons{display:flex;gap:10px;justify-content:flex-start;margin-bottom:14px}
  .top-buttons button{padding:10px 14px;border-radius:8px;border:none;color:#fff;font-weight:700;cursor:pointer}
  .resetHome{background:#f6a03f}.resetAll{background:#e44545}.inputData{background:#2e8d47}
  .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
  label{font-weight:700;color:#2b7a38}
  input[type="date"],input[type="number"],#spendInput{padding:9px;border-radius:8px;border:1px solid #8dcc90;font-size:15px}
  #spendInput{width:240px}
  .summary{background:#dff4e3;padding:12px;border-radius:10px;margin-bottom:14px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;align-items:center}
  .summary .item{font-size:15px}
  .summary .item strong{color:#146b2a;margin-left:6px}
  .healthBarContainer{grid-column:1/-1;height:20px;background:#e6f2e9;border-radius:10px;overflow:hidden;margin-top:6px}
  .healthBarFill{height:100%;width:0%;background:linear-gradient(90deg,#f44336,#ff9800,#ffeb3b,#4caf50);transition:width .35s ease;border-radius:10px}
  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
  th,td{border:1px solid #d7efd7;padding:10px;text-align:center}
  th{background:#cfead0}
  .usedBudget{width:140px;padding:6px;border-radius:6px;border:1px solid #8dcc90}
  .smallNote{font-size:12px;color:#666}
  @media(max-width:700px){ .summary{grid-template-columns:1fr} #spendInput{width:160px} }
</style>
</head>
<body>

<!-- fast check before module loads -->
<script>
  // Must match login page key: "loggedInUser"
  if (!localStorage.getItem("loggedInUser")) {
    alert("You must login first.");
    window.location.href = "login.html";
  }
</script>

<div class="topbar">
  <div class="userRow">
    Logged in as: <span id="welcomeUser" style="margin-left:8px;"></span>
  </div>
  <div>
    <button id="btnLogout">Logout</button>
  </div>
</div>

<div class="container">
  <h2>Budget Dashboard</h2>

  <div class="top-buttons">
    <button id="btnResetHome" class="resetHome">Reset</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnInputData" class="inputData">Input Data</button>
  </div>

  <div class="controls">
    <div>
      <label>From:</label><br>
      <input type="date" id="dateFrom">
    </div>

    <div>
      <label>To:</label><br>
      <input type="date" id="dateTo">
    </div>

    <div>
      <label for="spendInput">Enter Spending Amount</label><br>
      <input id="spendInput" type="number" placeholder="e.g. 10.50" step="0.01" />
      <div class="smallNote">Type an amount and press Enter to add to <strong>today</strong>'s spending</div>
    </div>
  </div>

  <div class="summary" id="summaryBlock">
    <div class="item">Total Income: RM <strong id="totalIncome">0.00</strong></div>
    <div class="item">Total Commitments: RM <strong id="totalCommit">0.00</strong></div>
    <div class="item">Net Income: RM <strong id="netIncome">0.00</strong></div>

    <div class="item">Days Left: <strong id="daysLeft">0</strong></div>
    <div class="item">Daily Budget (varies): RM <strong id="dailyBudget">0.00</strong></div>
    <div class="item">Remaining Net: RM <strong id="remainingNet">0.00</strong></div>

    <div style="grid-column:1/-1">
      <div class="healthBarContainer"><div id="healthBarFill" class="healthBarFill"></div></div>
      <div style="text-align:right;margin-top:6px;"><span id="healthPercent" style="font-weight:700;color:#146b2a">0%</span></div>
    </div>
  </div>

  <table id="budgetTable">
    <thead>
      <tr><th>Date</th><th>Daily Budget</th><th>Budget Used (editable)</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
/* Firebase imports */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  measurementId: "G-2LL0GD2K30",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM & user */
const USER = localStorage.getItem("loggedInUser"); // required auth key
if (!USER) { alert("You must login first."); window.location.href = "login.html"; throw new Error("Not logged in"); }
document.getElementById("welcomeUser").textContent = USER;
const userBase = `users/${USER}`;

const dateFromEl = document.getElementById("dateFrom");
const dateToEl = document.getElementById("dateTo");
const spendInput = document.getElementById("spendInput");
const tbody = document.querySelector("#budgetTable tbody");

/* Helpers - local timezone date string builder */
function localDateStr(d) {
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, '0');
  const da = String(dt.getDate()).padStart(2, '0');
  return `${y}-${m}-${da}`;
}
function todayLocal() { return localDateStr(new Date()); }
function sumUsedBeforeDate(usedMap, dateStr) {
  let total = 0;
  Object.keys(usedMap || {}).forEach(k => {
    if (k < dateStr) total += Number(usedMap[k] || 0);
  });
  return total;
}

/* Load salary & commitments (root paths) */
async function loadIncomeCommitments() {
  try {
    const salarySnap = await get(ref(db, `salary`));
    const partSnap = await get(ref(db, `partTime`));
    const commitSnap = await get(ref(db, `commitments`));

    const salary = salarySnap.exists() ? Number(salarySnap.val()) : 0;
    const partTime = partSnap.exists() ? Number(partSnap.val()) : 0;
    const commits = commitSnap.exists() ? commitSnap.val() : {};

    let totalCommit = 0;
    const keys = ["rent","motorcycle","telco","electric","water","shopee"];
    keys.forEach(k => {
      const n = Number(commits[k] || 0);
      if (!isNaN(n)) totalCommit += n;
    });

    if (commits.other) {
      if (Array.isArray(commits.other)) commits.other.forEach(o => totalCommit += Number(o.amount || 0));
      else Object.values(commits.other).forEach(o => totalCommit += Number((o && (o.amount || o)) || 0));
    }

    return { totalIncome: salary + partTime, totalCommit };
  } catch (e) {
    console.error("loadIncomeCommitments", e);
    return { totalIncome: 0, totalCommit: 0 };
  }
}

/* Set used value for a specific date (overwrite) */
async function setUsedValue(dateStr, value) {
  try {
    const node = ref(db, `${userBase}/homeBudget/${dateStr}`);
    if (value === "" || value === null || value === undefined) {
      await remove(node);
    } else {
      await set(node, Number(value));
    }
  } catch (e) {
    console.error("setUsedValue", e);
  }
}

/* Add amount to today's used (Q1 behavior - add mode) */
async function addToToday(amount) {
  try {
    const d = todayLocal();
    const node = ref(db, `${userBase}/homeBudget/${d}`);
    const snap = await get(node);
    const existing = snap.exists() ? Number(snap.val()) : 0;
    const next = existing + Number(amount);
    await set(node, next);
    spendInput.value = "";
    await updateDashboard();
    spendInput.focus();
  } catch (e) {
    console.error("addToToday", e);
    alert("Failed to add spending. See console.");
  }
}

/* Generate table with rolling Option A2 (local dates) */
async function generateTableWithRolling(fromDate, toDate, netIncome, usedMap) {
  tbody.innerHTML = "";

  const from = new Date(fromDate); from.setHours(0,0,0,0);
  const to = new Date(toDate); to.setHours(0,0,0,0);
  const today = new Date(); today.setHours(0,0,0,0);
  const oneDay = 86400000;

  // Build local date list
  const dates = [];
  for (let d = new Date(from); d <= to; d = new Date(d.getTime() + oneDay)) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const da = String(d.getDate()).padStart(2, '0');
    dates.push(`${y}-${m}-${da}`);
  }

  for (let i = 0; i < dates.length; i++) {
    const dateStr = dates[i];
    const tr = document.createElement("tr");

    // cumulative used before this date
    const cumulativeBefore = sumUsedBeforeDate(usedMap, dateStr);

    // days left including this date
    const dd = new Date(dateStr); dd.setHours(0,0,0,0);
    const daysLeftIncluding = Math.ceil((to - dd) / oneDay) + 1;

    let dailyBudgetDisplay = "-";
    if (new Date(dateStr) < today) {
      dailyBudgetDisplay = "0.00";
    } else {
      const remainingBefore = netIncome - cumulativeBefore;
      const db = daysLeftIncluding > 0 ? (remainingBefore / daysLeftIncluding) : 0;
      dailyBudgetDisplay = db.toFixed(2);
    }

    const usedVal = usedMap && usedMap[dateStr] !== undefined ? usedMap[dateStr] : "";

    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${dailyBudgetDisplay}</td>
      <td>
        <input class="usedBudget" type="number" step="0.01" value="${usedVal}" data-date="${dateStr}" />
      </td>
    `;
    tbody.appendChild(tr);

    // manual overwrite listener
    const input = tr.querySelector(".usedBudget");
    input.addEventListener("change", async (ev) => {
      const v = ev.target.value;
      if (v === "" || v === null) {
        await setUsedValue(dateStr, "");
      } else {
        const n = Number(v);
        if (isNaN(n)) {
          alert("Please enter a valid number");
          ev.target.value = usedMap[dateStr] ?? "";
          return;
        }
        await setUsedValue(dateStr, n);
      }
      await updateDashboard();
    });
  }
}

/* Update summary and health bar */
async function updateSummaryAndHealth(netIncome, totalIncome, totalCommit, usedMap, fromDate, toDate) {
  let usedTotal = 0;
  Object.values(usedMap || {}).forEach(v => usedTotal += Number(v || 0));
  const remainingNet = netIncome - usedTotal;

  const today = new Date(); today.setHours(0,0,0,0);
  const to = new Date(toDate); to.setHours(0,0,0,0);
  const oneDay = 86400000;
  const daysLeft = Math.max(0, Math.ceil((to - today) / oneDay));

  document.getElementById("totalIncome").textContent = (totalIncome).toFixed(2);
  document.getElementById("totalCommit").textContent = (totalCommit).toFixed(2);
  document.getElementById("netIncome").textContent = (netIncome).toFixed(2);

  document.getElementById("daysLeft").textContent = daysLeft;
  const rangeDays = Math.ceil((new Date(toDate) - new Date(fromDate)) / oneDay) + 1;
  const base = rangeDays > 0 ? (netIncome / rangeDays) : 0;
  document.getElementById("dailyBudget").textContent = base.toFixed(2);
  document.getElementById("remainingNet").textContent = remainingNet.toFixed(2);

  let percent = totalIncome > 0 ? (remainingNet / totalIncome) * 100 : 0;
  percent = Math.max(0, Math.min(100, percent));
  const bar = document.getElementById("healthBarFill");
  const txt = document.getElementById("healthPercent");
  bar.style.width = percent + "%";
  if (percent <= 20) bar.style.background = "red";
  else if (percent <= 40) bar.style.background = "orange";
  else if (percent <= 60) bar.style.background = "gold";
  else if (percent <= 80) bar.style.background = "#a2e05e";
  else bar.style.background = "#2ecc71";
  txt.textContent = percent.toFixed(1) + "%";
}

/* Main update: loads data and renders everything */
async function updateDashboard() {
  try {
    // default dates if missing
    let df = dateFromEl.value;
    let dt = dateToEl.value;
    if (!df || !dt) {
      const t = todayLocal();
      if (!df) dateFromEl.value = t;
      if (!dt) dateToEl.value = t;
      df = dateFromEl.value;
      dt = dateToEl.value;
      await update(ref(db, `${userBase}/homeDates`), { from: df, to: dt });
    }

    const { totalIncome, totalCommit } = await loadIncomeCommitments();
    const netIncome = totalIncome - totalCommit;

    const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
    const usedMap = usedSnap.exists() ? usedSnap.val() : {};

    await generateTableWithRolling(df, dt, netIncome, usedMap);
    await updateSummaryAndHealth(netIncome, totalIncome, totalCommit, usedMap, df, dt);
  } catch (e) {
    console.error("updateDashboard", e);
  }
}

/* Save date range */
async function saveDates() {
  try {
    const from = dateFromEl.value || "";
    const to = dateToEl.value || "";
    await update(ref(db, `${userBase}/homeDates`), { from, to });
    await updateDashboard();
  } catch (e) {
    console.error("saveDates", e);
  }
}

/* Reset home only */
async function resetHome() {
  if (!confirm("Reset only Home budget data? This will clear home spending and dates.")) return;
  try {
    await remove(ref(db, `${userBase}/homeBudget`));
    await remove(ref(db, `${userBase}/homeDates`));
    dateFromEl.value = "";
    dateToEl.value = "";
    await updateDashboard();
  } catch (e) {
    console.error("resetHome", e);
    alert("Reset home failed. See console.");
  }
}

/* Reset all (salary, partTime, commitments, user node) */
async function resetAll() {
  if (!confirm("RESET ALL DATA for this user? This deletes salary, commitments, home data.")) return;
  try {
    await remove(ref(db, `salary`));
    await remove(ref(db, `partTime`));
    await remove(ref(db, `commitments`));
    await remove(ref(db, `${userBase}`));
    localStorage.removeItem("loggedInUser");
    alert("All data cleared for this user.");
    window.location.href = "login.html";
  } catch (e) {
    console.error("resetAll", e);
    alert("Reset all failed. See console.");
  }
}

/* Navigation */
function goInput() { window.location.href = "SalaryInput.html"; }

/* Wiring */
document.getElementById("btnLogout").addEventListener("click", () => {
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
});
document.getElementById("btnResetHome").addEventListener("click", resetHome);
document.getElementById("btnResetAll").addEventListener("click", resetAll);
document.getElementById("btnInputData").addEventListener("click", goInput);
dateFromEl.addEventListener("change", saveDates);
dateToEl.addEventListener("change", saveDates);

// Enter on quick input adds to today
spendInput.addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") {
    const v = spendInput.value;
    if (v === "" || v === null) return;
    const num = Number(v);
    if (isNaN(num)) { alert("Please enter a valid number"); return; }
    addToToday(num);
  }
});

/* Init: restore dates then update */
(async function init(){
  try {
    const dSnap = await get(ref(db, `${userBase}/homeDates`));
    if (dSnap.exists()) {
      const d = dSnap.val();
      if (d.from) dateFromEl.value = d.from;
      if (d.to) dateToEl.value = d.to;
    } else {
      const t = todayLocal();
      dateFromEl.value = t;
      dateToEl.value = t;
    }
    await updateDashboard();
  } catch (e) {
    console.error("init", e);
  }
})();
</script>
</body>
</html>

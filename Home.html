<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Home - Budget Dashboard</title>
<style>
  body{font-family:Arial;background:#f2faf3;margin:0;padding:20px}
  .container{max-width:900px;margin:auto;background:#fff;padding:25px;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.12)}
  h2{text-align:center;color:#2c7a3f;margin-bottom:20px;font-size:26px}
  .top-buttons{display:flex;justify-content:space-between;margin-bottom:20px}
  button{padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;color:#fff;transition:.2s}
  button:hover{opacity:.85;transform:scale(.98)}
  #btnLogout{background:#444}
  .resetHome{background:#f6a03f}
  .resetAll{background:#e44545}
  .inputData{background:#2e8d47}
  label{font-weight:bold;margin-top:10px;display:inline-block;color:#2b7a38}
  input[type="date"],input[type="number"]{padding:9px;margin-top:5px;margin-bottom:15px;border-radius:8px;border:1px solid #8dcc90;font-size:15px;width:220px}
  .summary{background:#dff4e3;padding:16px;border-radius:12px;margin-bottom:20px;font-size:16px}
  .summary p span{font-weight:bold;color:#146b2a}
  table{width:100%;border-collapse:collapse;margin-top:20px;font-size:15px}
  th,td{border:1px solid #b5dfbb;padding:10px;text-align:center}
  th{background:#bfe6c7;font-weight:bold}
  .usedBudget{width:80px;padding:6px;border:1px solid #8dcc90;border-radius:6px}
  .healthBarContainer{width:100%;height:22px;background:#d9e9dc;border-radius:12px;overflow:hidden;margin-top:6px}
  .healthBarFill{height:100%;width:0%;background:linear-gradient(90deg,red,orange,yellow,#2ecc71);transition:width .4s ease;border-radius:12px}
  .loggedRow{display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-bottom:8px}
</style>
</head>
<body>

<div class="loggedRow">
  <div style="color:#2c7a3f;font-weight:700">Logged in as: <span id="welcomeUser"></span></div>
  <button id="btnLogout">Logout</button>
</div>

<div class="container">
  <h2>Budget Dashboard</h2>

  <div class="top-buttons">
    <button id="btnResetHome" class="resetHome">Reset</button>
    <button id="btnResetAll" class="resetAll">Reset All</button>
    <button id="btnInputData" class="inputData">Input Data</button>
  </div>

  <label>From:</label>
  <input type="date" id="dateFrom" onchange="saveDates(); updateDashboard()">
  <label>To:</label>
  <input type="date" id="dateTo" onchange="saveDates(); updateDashboard()">

  <div class="summary">
    <p>Total Income: RM <span id="totalIncome">0</span></p>
    <p>Total Commitments: RM <span id="totalCommit">0</span></p>
    <p>Net Income: RM <span id="netIncome">0</span></p>
    <p>Days Left Until Salary: <span id="daysLeft">0</span></p>
    <p>Daily Budget (Base): RM <span id="dailyBudget">0</span></p>
    <p>Remaining Net Income: RM <span id="remainingNet">0</span></p>

    <label style="font-weight:bold;color:#2b7a38">Budget Health:</label>
    <div class="healthBarContainer"><div id="healthBarFill" class="healthBarFill"></div></div>
    <div id="healthPercent" style="margin-top:6px;font-weight:bold;color:#146b2a">0%</div>
  </div>

  <table id="budgetTable">
    <thead><tr><th>Date</th><th>Daily Budget</th><th>Budget Used</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  measurementId: "G-2LL0GD2K30",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const USER = localStorage.getItem("loggedInUser");
if(!USER){ alert("You must login first."); window.location.href = "login.html"; throw new Error("Not logged in"); }
document.getElementById("welcomeUser").textContent = USER;
const userBase = `users/${USER}`;

function dateToISO(d){ const t = new Date(d); t.setHours(0,0,0,0); return t.toISOString().split("T")[0]; }

async function loadIncomeCommitments(){
  const salarySnap = await get(ref(db, `${userBase}/salary`));
  const partSnap = await get(ref(db, `${userBase}/partTime`));
  const commitSnap = await get(ref(db, `${userBase}/commitments`));
  const salary = salarySnap.exists()? Number(salarySnap.val()):0;
  const part = partSnap.exists()? Number(partSnap.val()):0;
  const commits = commitSnap.exists()? commitSnap.val():{};
  let totalCommit=0;
  const keys=["rent","motorcycle","telco","electric","water","shopee"];
  keys.forEach(k=>{const n = Number(commits[k]||0); if(!isNaN(n)) totalCommit+=n;});
  if(commits.other){
    if(Array.isArray(commits.other)) commits.other.forEach(o=>{ const n=Number(o.amount||0); if(!isNaN(n)) totalCommit+=n;});
    else Object.values(commits.other).forEach(o=>{ const n=Number(o.amount||o||0); if(!isNaN(n)) totalCommit+=n;});
  }
  return { totalIncome: salary+part, totalCommit };
}

window.saveUsedBudget = async function(dateStr,value){
  const node = ref(db, `${userBase}/homeBudget/${dateStr}`);
  if(value === "" || value === null) await remove(node);
  else { const n = Number(value); if(!isNaN(n)) await set(node,n); }
  await updateDashboard();
};

async function updateSummaryOnly(base, from, to){
  const { totalIncome, totalCommit } = await loadIncomeCommitments();
  const net = totalIncome - totalCommit;

  const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
  let usedTotal=0;
  if(usedSnap.exists()) Object.values(usedSnap.val()).forEach(v=>usedTotal+=Number(v||0));
  const remaining = net - usedTotal;

  document.getElementById("totalIncome").textContent = totalIncome.toFixed(2);
  document.getElementById("totalCommit").textContent = totalCommit.toFixed(2);
  document.getElementById("netIncome").textContent = net.toFixed(2);
  document.getElementById("dailyBudget").textContent = base.toFixed(2);
  document.getElementById("remainingNet").textContent = remaining.toFixed(2);

  let percent = totalIncome > 0 ? (remaining/totalIncome)*100 : 0;
  percent = Math.max(0,Math.min(100,percent));
  const bar = document.getElementById("healthBarFill");
  const txt = document.getElementById("healthPercent");
  bar.style.width = percent + "%";
  if(percent<=20) bar.style.background="red";
  else if(percent<=40) bar.style.background="orange";
  else if(percent<=60) bar.style.background="gold";
  else if(percent<=80) bar.style.background="#a2e05e";
  else bar.style.background="#2ecc71";
  txt.textContent = percent.toFixed(1) + "%";
}

async function generateTable(from,to,base){
  const tbody = document.querySelector("#budgetTable tbody");
  tbody.innerHTML = "";
  const usedSnap = await get(ref(db, `${userBase}/homeBudget`));
  const used = usedSnap.exists()? usedSnap.val(): {};
  const oneDay = 86400000;
  let cur = new Date(from); cur.setHours(0,0,0,0);
  while(cur <= to){
    const ds = cur.toISOString().split("T")[0];
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${ds}</td><td>${base.toFixed(2)}</td><td><input class="usedBudget" type="number" value="${used[ds] ?? ""}" oninput="saveUsedBudget('${ds}', this.value)"></td>`;
    tbody.appendChild(tr);
    cur = new Date(cur.getTime()+oneDay);
  }
}

window.updateDashboard = async function(){
  const df = document.getElementById("dateFrom").value;
  const dt = document.getElementById("dateTo").value;
  if(!df || !dt) return;
  const from = new Date(df); from.setHours(0,0,0,0);
  const to = new Date(dt); to.setHours(0,0,0,0);
  const { totalIncome, totalCommit } = await loadIncomeCommitments();
  const net = totalIncome - totalCommit;
  const days = Math.ceil((to - from)/86400000)+1;
  const base = net / Math.max(1,days);
  await updateSummaryOnly(base, from, to);
  await generateTable(from, to, base);
};

window.saveDates = async function(){
  const from = document.getElementById("dateFrom").value || "";
  const to = document.getElementById("dateTo").value || "";
  await update(ref(db, `${userBase}/homeDates`), { from, to });
};

window.resetHome = async function(){
  if(!confirm("Reset only Home budget data?")) return;
  await remove(ref(db, `${userBase}/homeBudget`));
  await remove(ref(db, `${userBase}/homeDates`));
  document.getElementById("dateFrom").value="";
  document.getElementById("dateTo").value="";
  updateDashboard();
};

window.resetAll = async function(){
  if(!confirm("RESET ALL DATA?")) return;
  await remove(ref(db, `${userBase}`));
  alert("User data cleared");
  localStorage.removeItem("loggedInUser");
  window.location.href = "login.html";
};

window.goInput = function(){ window.location.href = "SalaryInput.html"; };

document.getElementById("btnLogout").onclick = function(){ localStorage.removeItem("loggedInUser"); window.location.href = "login.html"; };
document.getElementById("btnResetHome").onclick = () => resetHome();
document.getElementById("btnResetAll").onclick = () => resetAll();
document.getElementById("btnInputData").onclick = () => goInput();

window.onload = async function(){
  try{
    const snap = await get(ref(db, `${userBase}/homeDates`));
    if(snap.exists()){ const d=snap.val(); if(d.from) document.getElementById("dateFrom").value = d.from; if(d.to) document.getElementById("dateTo").value = d.to; }
    updateDashboard();
  }catch(e){ console.error(e); }
};
</script>
</body>
</html>

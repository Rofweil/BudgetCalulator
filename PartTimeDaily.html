<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Part Time Daily</title>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f2faf3;margin:0;padding:15px}
  .container{max-width:1000px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  h2{text-align:center;color:#2c7a3f}
  label{font-weight:bold;display:block;margin-top:10px;color:#2b7a38}
  input[type="date"],input[type="number"]{width:100%;padding:9px;border-radius:8px;border:1px solid #8dcc90;margin-top:6px}
  .summary{background:#dff4e3;padding:12px;border-radius:10px;margin-top:12px}
  .toggleRow{margin-top:10px;display:flex;align-items:center;gap:10px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #b5dfbb;padding:8px;text-align:center}
  th{background:#bfe6c7}
  .amountInput{width:80px}
  button{padding:10px;border:none;border-radius:8px;color:#fff;font-weight:bold;margin-top:12px}
  .save{background:#2e8d47;width:100%}
  .back{background:#444;width:100%;margin-top:8px}
</style>
</head>

<body>

<p style="text-align:right;color:#2c7a3f;font-weight:bold">Logged in as: <span id="welcomeUser"></span></p>

<script>
(function(){
  const u = localStorage.getItem("loggedInUser");
  if(!u){ alert("You must login first!"); window.location.href="login.html"; return; }
  window.CURRENT_USER = u;
  document.addEventListener("DOMContentLoaded", ()=> document.getElementById("welcomeUser").textContent = u );
})();
</script>

<div class="container">
  <h2>Part Time Daily Earnings</h2>

  <label>From:</label>
  <input id="dateFrom" type="date" onchange="loadTable(); saveDates()">

  <label>To:</label>
  <input id="dateTo" type="date" onchange="loadTable(); saveDates()">

  <label>Goal Amount (RM):</label>
  <input id="goalAmount" type="number" placeholder="Enter target" oninput="saveGoal()">

  <div class="toggleRow">
    <input type="checkbox" id="showDailyGoal" onchange="loadTable(); saveShowDaily()">
    <label for="showDailyGoal" style="margin-top:0">Show Daily Goal</label>
  </div>

  <div class="summary">
    <p>Total Earned: RM <span id="totalEarned">0.00</span></p>
    <p>Goal Amount: RM <span id="goalDisplay">0.00</span></p>
    <p>Remaining: RM <span id="remaining">0.00</span></p>
  </div>

  <table id="ptTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Daily Goal</th>
        <th>Earned</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="save" onclick="saveAll()">Save All</button>
  <button class="back" onclick="window.location.href='Home.html'">Back to Home</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
initializeApp(firebaseConfig);
const db = getDatabase();

const USER = window.CURRENT_USER;
const base = path => `users/${USER}/partTimeDaily/${path}`;

function format(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

/* ---------------------- SAVE SETTINGS ---------------------- */
async function saveDates(){
  await update(ref(db, base("settings")), {
    from: document.getElementById("dateFrom").value,
    to: document.getElementById("dateTo").value
  });
}

async function saveGoal(){
  const v = document.getElementById("goalAmount").value;
  await update(ref(db, base("settings")), { goal: v });
  updateSummary();
}

async function saveShowDaily(){
  const v = document.getElementById("showDailyGoal").checked;
  await update(ref(db, base("settings")), { showDaily: v });
  loadTable();
}

/* ---------------------- LOAD SETTINGS ---------------------- */
async function loadSettings(){
  const snap = await get(ref(db, base("settings")));
  if(snap.exists()){
    const d = snap.val();
    if(d.from) document.getElementById("dateFrom").value = d.from;
    if(d.to) document.getElementById("dateTo").value = d.to;
    if(d.goal) document.getElementById("goalAmount").value = d.goal;
    if(d.showDaily) document.getElementById("showDailyGoal").checked = true;
  }
}

/* ---------------------- LOAD TABLE ------------------------- */
async function loadTable(){
  const f = document.getElementById("dateFrom").value;
  const t = document.getElementById("dateTo").value;
  if(!f || !t) return;

  const from = new Date(f);
  const to = new Date(t);

  const showDaily = document.getElementById("showDailyGoal").checked;
  const goal = Number(document.getElementById("goalAmount").value || 0);
  const totalDays = Math.max(1, Math.floor((to - from) / 86400000) + 1);
  const dailyGoal = showDaily ? (goal / totalDays) : "";

  const table = document.querySelector("#ptTable tbody");
  table.innerHTML = "";

  const snap = await get(ref(db, base("records")));
  const saved = snap.exists() ? snap.val() : {};

  let current = new Date(from);
  while(current <= to){
    const ds = format(current);

    const val = saved[ds] ?? "";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${ds}</td>
      <td>${showDaily ? dailyGoal.toFixed(2) : "-"}</td>
      <td><input class="amountInput" type="number" step="0.01" id="amt-${ds}" value="${val}"></td>
    `;
    table.appendChild(row);

    current.setDate(current.getDate()+1);
  }
  updateSummary();
}

/* ---------------------- SAVE ALL EARNINGS ---------------------- */
async function saveAll(){
  const inputs = document.querySelectorAll(".amountInput");
  const out = {};

  inputs.forEach(i=>{
    const id = i.id.replace("amt-","");
    out[id] = i.value || "";
  });

  await set(ref(db, base("records")), out);
  alert("Saved!");
  updateSummary();
}

/* ---------------------- SUMMARY ---------------------- */
async function updateSummary(){
  const snap = await get(ref(db, base("records")));
  const data = snap.exists() ? snap.val() : {};

  let total = 0;
  Object.values(data).forEach(v=>{
    if(!isNaN(parseFloat(v))) total += parseFloat(v);
  });

  const goal = Number(document.getElementById("goalAmount").value || 0);
  const remaining = goal - total;

  document.getElementById("totalEarned").textContent = total.toFixed(2);
  document.getElementById("goalDisplay").textContent = goal.toFixed(2);
  document.getElementById("remaining").textContent = remaining.toFixed(2);
}

/* ---------------------- INITIAL LOAD ---------------------- */
window.onload = async ()=>{
  await loadSettings();
  await loadTable();
};
</script>

</body>
</html>

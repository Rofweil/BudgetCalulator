<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Part-Time Daily Goal</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #eef8f0;
        margin: 0;
        padding: 20px;
    }

    .container {
        max-width: 850px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 14px;
        box-shadow: 0 0 12px rgba(0,0,0,0.15);
    }

    h2 {
        text-align: center;
        color: #2e7d32;
        margin-bottom: 18px;
    }

    label {
        font-weight: bold;
        display: block;
        margin-top: 12px;
        color: #1b5e20;
    }

    input[type="date"], input[type="number"] {
        padding: 9px;
        border-radius: 8px;
        border: 1px solid #8dcc90;
        margin-top: 5px;
        margin-bottom: 15px;
        width: 220px;
        font-size: 15px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 18px;
        font-size: 15px;
    }

    th, td {
        border: 1px solid #b5dfbb;
        padding: 10px;
        text-align: center;
    }

    th {
        background: #bfe6c7;
    }

    .good { background: #d7f5d8 !important; }
    .bad  { background: #ffd6d6 !important; }
    .today { background: #fff7c2 !important; }

    .earnedInput {
        width: 90px;
        padding: 6px;
        border: 1px solid #8dcc90;
        border-radius: 6px;
    }

    .top-buttons {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    button {
        padding: 10px 14px;
        border-radius: 8px;
        border: none;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }

    .resetBtn { background: #e25252; }
    .saveBtn  { background: #2e8d47; }
</style>
</head>
<body>

<div class="container">
    <h2>Part-Time Daily Goal Tracker</h2>

    <div class="top-buttons">
        <button class="resetBtn" onclick="resetAll()">Reset All</button>
        <button class="saveBtn" onclick="saveAll()">Save All</button>
    </div>

    <label>From Date</label>
    <input type="date" id="dateFrom" onchange="saveDatesAndReload()">

    <label>To Date</label>
    <input type="date" id="dateTo" onchange="saveDatesAndReload()">

    <label>Total Goal Amount (RM)</label>
    <input type="number" id="totalGoal" oninput="saveGoalAndReload()">

    <table id="dailyTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Daily Goal</th>
                <th>Earned</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const USER_ID = "guest_user_1";

// ðŸ”’ DAILY GOAL FREEZE
let frozenDailyGoal = null;

// ---------- GET DATE STRING ----------
function fmt(date) {
    const y = date.getFullYear();
    const m = ("0" + (date.getMonth()+1)).slice(-2);
    const d = ("0" + date.getDate()).slice(-2);
    return `${y}-${m}-${d}`;
}

// ---------- LOAD EVERYTHING ----------
window.onload = async function () {

    // Load frozen goal
    const goalSnap = await db.ref("users/" + USER_ID + "/dailyGoal").once("value");
    frozenDailyGoal = goalSnap.val() || null;

    // Load date range
    const dateSnap = await db.ref("users/" + USER_ID + "/dailyRange").once("value");
    if (dateSnap.val()) {
        dateFrom.value = dateSnap.val().from || "";
        dateTo.value = dateSnap.val().to || "";
    }

    // Load total goal
    const tgSnap = await db.ref("users/" + USER_ID + "/totalGoal").once("value");
    totalGoal.value = tgSnap.val() || "";

    generateTable();
};

// ---------- SAVE DATES ----------
function saveDatesAndReload(){
    db.ref("users/" + USER_ID + "/dailyRange").set({
        from: dateFrom.value,
        to: dateTo.value
    });
    generateTable();
}

// ---------- SAVE TOTAL GOAL ----------
function saveGoalAndReload(){
    db.ref("users/" + USER_ID + "/totalGoal").set(Number(totalGoal.value) || 0);
    generateTable();
}

// ---------- SAVE PER-DAY EARNED ----------
function saveEarned(dateStr, value) {
    db.ref("users/" + USER_ID + "/earned/" + dateStr).set(Number(value) || 0);
}

// ---------- RESET ----------
function resetAll(){
    if (!confirm("Reset everything?")) return;

    db.ref("users/" + USER_ID).remove().then(() => location.reload());
}

// ---------- SAVE ALL (earned values) ----------
function saveAll(){
    alert("All updated!");
}

// ---------- MAIN TABLE GENERATION ----------
async function generateTable(){

    if (!dateFrom.value || !dateTo.value || !totalGoal.value) return;

    const tbody = document.querySelector("#dailyTable tbody");
    tbody.innerHTML = "";

    const start = new Date(dateFrom.value);
    const end   = new Date(dateTo.value);

    const totalGoalValue = Number(totalGoal.value);
    const oneDay = 86400000;

    // Load earned data
    const earnedSnap = await db.ref("users/" + USER_ID + "/earned").once("value");
    const earnedData = earnedSnap.val() || {};

    // Count days
    let totalDays = Math.floor((end - start) / oneDay) + 1;

    // Sum earned so far
    let earnedSoFar = 0;

    // Loop through days
    let index = 0;
    for (let d = new Date(start); d <= end; d = new Date(d.getTime() + oneDay)) {

        const dateStr = fmt(d);
        const todayStr = fmt(new Date());

        const earnedToday = Number(earnedData[dateStr] || 0);
        earnedSoFar += earnedToday;

        let dailyGoal;

        // ðŸŒŸ FROZEN DAILY GOAL LOGIC ðŸŒŸ
        if (frozenDailyGoal !== null) {
            dailyGoal = frozenDailyGoal;
        } else {
            // First-time calculation
            const remainingGoal = totalGoalValue - earnedSoFar;
            const remainingDays = totalDays - index;

            dailyGoal = remainingGoal / remainingDays;

            await db.ref("users/" + USER_ID + "/dailyGoal").set(dailyGoal);
            frozenDailyGoal = dailyGoal;
        }

        // Build table row
        const tr = document.createElement("tr");

        if (dateStr < todayStr)      tr.classList.add(earnedToday >= dailyGoal ? "good" : "bad");
        else if (dateStr === todayStr) tr.classList.add("today");

        const td1 = document.createElement("td");
        td1.textContent = dateStr;

        const td2 = document.createElement("td");
        td2.textContent = dailyGoal.toFixed(2);

        const td3 = document.createElement("td");

        const input = document.createElement("input");
        input.type = "number";
        input.className = "earnedInput";
        input.value = earnedToday || "";

        if (dateStr < todayStr) {
            input.disabled = true; // lock past days
        }

        input.oninput = () => saveEarned(dateStr, input.value);

        td3.appendChild(input);

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tbody.appendChild(tr);

        index++;
    }
}

</script>
</body>
</html>

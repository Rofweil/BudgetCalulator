<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Part Time Daily</title>
<style>
  :root{
    --green:#2e8d47;
    --light:#dff4e3;
    --accent:#2c7a3f;
    --danger:#e44545;
    --muted:#8dcc90;
    --bg:#f2faf3;
  }
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:15px}
  .container{max-width:1000px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  h2{color:var(--accent);text-align:center;margin:0 0 12px}
  label{display:block;margin-top:10px;font-weight:bold;color:#2b7a38}
  input[type="date"],input[type="number"]{width:100%;padding:9px;border-radius:8px;border:1px solid var(--muted);margin-top:6px;box-sizing:border-box}
  .summary{background:var(--light);padding:12px;border-radius:10px;margin-top:12px}
  .toggleRow{margin-top:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #b5dfbb;padding:8px;text-align:center}
  th{background:#bfe6c7}
  .amountInput{width:110px;padding:6px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{flex:1;padding:10px;border-radius:8px;border:none;color:#fff;font-weight:bold;cursor:pointer}
  .save{background:var(--green)} .back{background:#444} .settingsSave{background:#1f8dd6}
  .past-good{background:#e8f8ed}    /* green-ish background for achieved past */
  .past-bad{background:#ffecec}     /* red-ish background for missed past */
  .today-row{background:#fffbea}    /* neutral highlight for today */
  .future-row{background:transparent}
  .small{font-size:13px;color:#333}
  @media(max-width:480px){ .amountInput{width:90px} .controls{flex-direction:column} }
  .mutedNote{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>

<p style="text-align:right;color:var(--accent);font-weight:bold">Logged in as: <span id="welcomeUser"></span></p>

<!-- Non-module login check: sets window.CURRENT_USER early -->
<script>
(function(){
  const user = localStorage.getItem("loggedInUser") || localStorage.getItem("loggedUser");
  if (!user || (typeof user==='string' && (user.trim()==="" || user==="null" || user==="undefined"))) {
    localStorage.removeItem("loggedInUser");
    localStorage.removeItem("loggedUser");
    alert("You must login first!");
    window.location.href = "login.html";
    return;
  }
  window.CURRENT_USER = user;
  document.addEventListener("DOMContentLoaded", ()=> {
    const el = document.getElementById("welcomeUser");
    if (el) el.textContent = user;
  });
})();
</script>

<div class="container">
  <h2>Part Time Daily Earnings</h2>

  <label for="dateFrom">From:</label>
  <input id="dateFrom" type="date">

  <label for="dateTo">To:</label>
  <input id="dateTo" type="date">

  <label for="goalAmount">Goal Amount (RM):</label>
  <input id="goalAmount" type="number" step="0.01" placeholder="Enter target">

  <div class="toggleRow">
    <input id="showDailyGoal" type="checkbox">
    <label for="showDailyGoal" style="margin-top:0">Show Daily Goal (if checked, original daily goal will be visible for computed cells)</label>
    <button id="btnSaveSettings" class="btn settingsSave" style="flex: none; margin-left:auto">Save Settings</button>
  </div>

  <div class="summary">
    <p>Total Earned: RM <strong><span id="totalEarned">0.00</span></strong></p>
    <p>Goal Amount: RM <strong><span id="goalDisplay">0.00</span></strong></p>
    <p>Remaining: RM <strong><span id="remaining">0.00</span></strong></p>
    <div class="mutedNote">Past rows are locked (read-only) and compare with the <strong>original daily goal</strong>. Today & future rows are editable.</div>
  </div>

  <table id="ptTable" aria-label="part-time table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Daily Goal</th>
        <th>Earned (RM)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="controls">
    <button id="btnSaveAll" class="btn save">Save All</button>
    <button id="btnBack" class="btn back">Back to Home</button>
  </div>
</div>

<!-- Module with Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA3q1drfYYuq0MGztqr8T6Cq42RGKmiVno",
  authDomain: "budgetcalculator-22ef5.firebaseapp.com",
  projectId: "budgetcalculator-22ef5",
  storageBucket: "budgetcalculator-22ef5.firebasestorage.app",
  messagingSenderId: "574952478496",
  appId: "1:574952478496:web:0ac32ab61ec6b130db2945",
  databaseURL: "https://budgetcalculator-22ef5-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const USER = window.CURRENT_USER;
if (!USER) {
  alert("Not logged in");
  window.location.href = "login.html";
}

// DB base path
const BASE = `users/${USER}/partTimeDaily`;

function formatDateLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function two(n){ return Number(n || 0).toFixed(2); }

/* ---------------- LOAD SETTINGS ---------------- */
async function loadSettings(){
  try {
    const snap = await get(ref(db, `${BASE}/settings`));
    if (!snap.exists()) return;
    const s = snap.val();
    if (s.from) document.getElementById("dateFrom").value = s.from;
    if (s.to) document.getElementById("dateTo").value = s.to;
    if (s.goal !== undefined) document.getElementById("goalAmount").value = s.goal;
    document.getElementById("showDailyGoal").checked = !!s.showDaily;
  } catch (err) { console.error(err); }
}

/* ---------------- SAVE SETTINGS ---------------- */
async function saveSettings(){
  try {
    await update(ref(db, `${BASE}/settings`), {
      from: document.getElementById("dateFrom").value,
      to: document.getElementById("dateTo").value,
      goal: document.getElementById("goalAmount").value,
      showDaily: document.getElementById("showDailyGoal").checked
    });
    await loadTable();
    alert("Settings saved.");
  } catch (err) { console.error(err); }
}

/* ---------------- UPDATED DAILY GOAL RULES (A) ---------------- */
async function loadTable(){
  try {
    const f = document.getElementById("dateFrom").value;
    const t = document.getElementById("dateTo").value;
    if (!f || !t) {
      document.querySelector("#ptTable tbody").innerHTML = "";
      updateSummary();
      return;
    }

    const from = new Date(f);
    const to = new Date(t);
    from.setHours(0,0,0,0);
    to.setHours(0,0,0,0);

    const goalTotal = Number(document.getElementById("goalAmount").value || 0);

    const snap = await get(ref(db, `${BASE}/records`));
    const saved = snap.exists() ? snap.val() : {};

    const today = new Date();
    today.setHours(0,0,0,0);
    const todayStr = formatDateLocal(today);

    // Calculate earned so far
    let earnedUpToToday = 0;
    let earnedPastOnly = 0;

    let current = new Date(from);
    while (current <= to) {
      const ds = formatDateLocal(current);
      const val = saved[ds];
      const num = (val === "" || val === undefined) ? 0 : Number(val);

      if (!isNaN(num)) {
        if (ds < todayStr) {
          earnedPastOnly += num;
          earnedUpToToday += num;
        }
        if (ds === todayStr) {
          earnedUpToToday += num;
        }
      }
      current.setDate(current.getDate() + 1);
    }

    const remainingGoal = Math.max(0, goalTotal - earnedUpToToday);

    // Count future days
    let futureDays = 0;
    current = new Date(from);
    while (current <= to) {
      const ds = formatDateLocal(current);
      if (ds > todayStr) futureDays++;
      current.setDate(current.getDate() + 1);
    }

    const showDaily = document.getElementById("showDailyGoal").checked;

    const tbody = document.querySelector("#ptTable tbody");
    tbody.innerHTML = "";

    current = new Date(from);
    while (current <= to) {
      const ds = formatDateLocal(current);
      const savedVal = saved[ds];
      const numVal = (savedVal === "" || savedVal === undefined) ? "" : Number(savedVal);

      let dailyGoal = "-";
      let rowClass = "";
      let earnedCell = "";

      if (ds < todayStr) {
        // past always compare to original daily goal
        const totalDays = Math.max(1, Math.floor((to - from)/86400000) + 1);
        const originalGoal = goalTotal / totalDays;

        dailyGoal = two(originalGoal);

        if (numVal >= originalGoal) rowClass = "past-good";
        else rowClass = "past-bad";

        earnedCell =
          `<input class="amountInput" type="number" step="0.01" value="${numVal === "" ? "" : two(numVal)}" data-date="${ds}" readonly>`;
      }

      else if (ds === todayStr) {
        // today uses fully dynamic rule
        const todayGoal =
          futureDays >= 0
            ? remainingGoal / (futureDays + 1)
            : 0;

        dailyGoal = two(todayGoal);
        rowClass = "today-row";

        earnedCell =
          `<input class="amountInput" type="number" step="0.01" value="${numVal === "" ? "" : two(numVal)}" data-date="${ds}">`;
      }

      else {
        // future uses fully dynamic recalculated daily goal
        const futureGoal =
          futureDays > 0
            ? remainingGoal / futureDays
            : 0;

        dailyGoal = two(futureGoal);
        rowClass = "future-row";

        earnedCell =
          `<input class="amountInput" type="number" step="0.01" value="${numVal === "" ? "" : two(numVal)}" data-date="${ds}">`;
      }

      const tr = document.createElement("tr");
      tr.className = rowClass;
      tr.innerHTML = `
        <td>${ds}</td>
        <td>
  ${
    showDaily
      ? dailyGoal              // show all daily goals when toggle is ON
      : (ds < todayStr
          ? dailyGoal          // past MUST always show original goal
          : "-"                // today & future hide when toggle is OFF
        )
  }
</td>

        <td>${earnedCell}</td>
      `;

      tbody.appendChild(tr);
      current.setDate(current.getDate() + 1);
    }

    // formatting
    document.querySelectorAll(".amountInput").forEach(input => {
      input.addEventListener("blur", () => {
        if (input.value !== "" && !isNaN(Number(input.value)))
          input.value = two(Number(input.value));
      });

      input.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          const date = input.dataset.date;
          await set(ref(db, `${BASE}/records/${date}`), input.value === "" ? "" : Number(input.value));
          await updateSummary();
          await loadTable();
        }
      });
    });

    await updateSummary();
  } catch (err) { console.error(err); }
}

/* ---------------- SUMMARY ---------------- */
async function updateSummary(){
  try {
    const snap = await get(ref(db, `${BASE}/records`));
    const records = snap.exists() ? snap.val() : {};
    let total = 0;
    for (let v of Object.values(records)) {
      if (v !== "" && !isNaN(Number(v))) total += Number(v);
    }
    const goal = Number(document.getElementById("goalAmount").value || 0);
    document.getElementById("totalEarned").textContent = two(total);
    document.getElementById("goalDisplay").textContent = two(goal);
    document.getElementById("remaining").textContent = two(goal - total);
  } catch (err) { console.error(err); }
}

/* ---------------- SAVE ALL ---------------- */
async function saveAll(){
  try {
    const inputs = document.querySelectorAll(".amountInput");
    const payload = {};
    inputs.forEach(i => payload[i.dataset.date] = i.value === "" ? "" : Number(i.value));
    await set(ref(db, `${BASE}/records`), payload);
    await updateSummary();
    await loadTable();
    alert("Saved all.");
  } catch (err) { console.error(err); }
}

/* ---------------- EVENTS ---------------- */
document.getElementById("btnSaveAll").addEventListener("click", saveAll);
document.getElementById("btnBack").addEventListener("click", ()=> window.location.href = "Home.html");
document.getElementById("btnSaveSettings").addEventListener("click", saveSettings);
document.getElementById("showDailyGoal").addEventListener("change", loadTable);

/* ---------------- INITIAL ---------------- */
window.addEventListener("load", async () => {
  await loadSettings();
  await loadTable();
});
</script>
</body>
</html>

